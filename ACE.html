<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>NYC Motor Vehicle Crashes vs ACE Enforcement Analysis</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
        }
        
        .unified-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(180deg, #181818 0%, #121212 100%);
            padding: 0;
            box-shadow: 0 -8px 32px rgba(0,0,0,0.6);
            font-size: 12px;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            z-index: 1000;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            border-top: 1px solid #282828;
        }
        

        .unified-panel h3 {
            margin: 0;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .stat {
            margin: 0;
            color: #b3b3b3;
            font-size: 11px;
            font-weight: 400;
            line-height: 1.4;
        }
        
        .view-controls {
            margin: 20px 0;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .data-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        
        .data-toggle > div {
            white-space: nowrap;
            font-weight: 600;
            margin-right: 8px;
            color: #ffffff;
            font-size: 13px;
        }
        
        .toggle-buttons {
            display: flex;
            gap: 6px;
            margin: 0;
            align-items: center;
        }
        
        .toggle-buttons button {
            font-size: 10px;
            padding: 6px 12px;
            text-align: center;
            white-space: nowrap;
            min-width: fit-content;
            border-radius: 16px;
        }
        
        #congestion-toggle {
            min-width: 80px;
            padding: 6px 16px;
        }
        
        .temporal-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px 8px clamp(100px, 7vw, 120px);
            flex-grow: 1;
        }
        
        /* Move just the date and info section down */
        .temporal-section > div:first-child {
            align-self: flex-end;
            margin-top: 15px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px 16px 2px 16px;
            margin-top: -12px;
            gap: 4px;
            position: relative;
        }
        
        .smooth-progress-overlay {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(300px, 28vw, 450px);
            height: 4px;
            background: linear-gradient(to right, #1db954 0%, #1db954 var(--progress, 0%), transparent var(--progress, 0%));
            border-radius: 2px;
            pointer-events: none;
            z-index: 1;
            transition: --progress 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
        }
        
        .smooth-progress-overlay.active {
            opacity: 1;
        }
        
        .slider-date-label {
            font-size: 11px;
            color: #ffffff;
            white-space: nowrap;
            font-weight: 400;
            min-width: 50px;
            text-align: center;
        }
        
        .time-slider {
            width: clamp(300px, 28vw, 450px);
            height: 4px;
            border-radius: 2px;
            background: #4f4f4f;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
        }
        
        .time-slider.smooth {
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .time-slider:hover {
            background: #535353;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        .time-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #1db954;
        }
        
        .time-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .month-display {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            white-space: nowrap;
            letter-spacing: -0.2px;
        }
        
        .crash-count, .ace-count {
            font-size: 13px;
            color: #b3b3b3;
            margin: 0;
            white-space: nowrap;
            font-weight: 400;
        }
        
        button {
            background: #2a2a2a;
            color: #b3b3b3;
            border: none;
            padding: 8px 16px;
            margin: 0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s ease;
            text-transform: capitalize;
        }
        
        .toggle-buttons button:hover {
            background: #3e3e3e;
            color: #ffffff;
            transform: scale(1.02);
        }
        
        button.active {
            background: #1db954;
            color: #000000;
            font-weight: 600;
        }
        
        .toggle-buttons button.active:hover {
            background: #1ed760;
            transform: scale(1.02);
        }
        
        .play-controls {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            position: absolute;
            left: 50%;
            top: 10px;
            transform: translateX(-50%);
            width: 280px;
        }
        
        .left-controls {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
        }
        
        .center-control {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .right-controls {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
        }
        
        .nav-button {
            background: transparent;
            border: none;
            width: 42px;
            height: 42px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: 22px 22px;
            background-repeat: no-repeat;
            background-position: center;
            filter: brightness(0) invert(1) opacity(0.6);
            transition: all 0.1s ease;
        }
        
        
        
        .nav-button.prev {
            background-image: url('Image_Sources/spotprev.png');
        }
        
        .nav-button.next {
            background-image: url('Image_Sources/spotnext.png');
        }
        
        .nav-button.loop {
            background-image: url('Image_Sources/loop.png');
        }
        
        .nav-button.speed {
            background: transparent;
            color: #ffffff;
            font-size: 11px;
            font-weight: 600;
            filter: brightness(0) invert(1) opacity(0.6);
        }
        
        .nav-button.speed:hover {
            filter: brightness(0) invert(1) opacity(1);
        }
        
        /* Loop button styling handled by JavaScript */
        
        .nav-button:hover {
            transform: scale(1.1);
        }
        
        .play-button:hover {
            transform: scale(1.1);
        }
        
        #loop-button.active {
            filter: none !important;
        }
        
        #loop-button.active:hover {
            filter: none !important;
        }
        
        .nav-button:focus {
            outline: none !important;
        }
        
        .nav-button:active {
            /* No changes on click */
        }
        
        /* Route Toggle Slider Styles */
        .route-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .route-toggle-label {
            font-size: 10px;
            color: #b3b3b3;
            font-weight: 400;
        }
        
        .route-toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 18px;
        }
        
        .route-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .route-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a4a4a;
            transition: .3s;
            border-radius: 18px;
        }
        
        .route-toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        .route-toggle-switch input:checked + .route-toggle-slider {
            background-color: #1db954;
        }
        
        .route-toggle-switch input:checked + .route-toggle-slider:before {
            transform: translateX(18px);
        }
        
        /* Triple Route Mode Slider */
        .triple-route-slider {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .route-mode-container {
            position: relative;
            width: 60px;
            height: 16px;
            background: #4a4a4a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .route-mode-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 12px;
            background: #ffffff;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .route-mode-container.mode-0 .route-mode-indicator {
            left: 2px;
            background: #ffffff; /* Keep white instead of blue */
        }
        
        .route-mode-container.mode-1 .route-mode-indicator {
            left: 21px;
            background: #ffffff; /* Keep white instead of green */
        }
        
        .route-mode-container.mode-2 .route-mode-indicator {
            left: 40px;
            background: #ffffff; /* Keep white instead of red */
        }
        
        .route-mode-label {
            font-size: 8px;
            color: #b3b3b3;
            white-space: nowrap;
        }
        
        /* Opacity Slider Styles */
        .opacity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            align-self: flex-start;
        }
        
        .opacity-control label {
            font-size: 10px;
            color: #ffffff;
            font-weight: 600;
            white-space: nowrap;
            min-width: 50px;
        }
        
        .opacity-slider {
            width: 80px;
            height: 3px;
            border-radius: 2px;
            background: #4f4f4f;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .opacity-slider:hover {
            background: #535353;
        }
        
        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        .opacity-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #1db954;
        }
        
        .opacity-slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .opacity-value {
            font-size: 9px;
            color: #b3b3b3;
            min-width: 25px;
            text-align: right;
        }
        
        .play-button {
            background: #ffffff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            font-size: 24px;
            color: #000000;
            font-weight: 600;
            line-height: 1;
            padding: 0;
            margin: 0;
            text-align: center;
            position: relative;
        }
        
        
        .play-button::after {
            content: attr(data-symbol);
            position: absolute;
            top: 50%;
            left: 50%;
        }
        
        .play-button[data-symbol="▶"]::after {
            transform: translate(calc(-50% + 2px), calc(-50% - 1px));
            font-size: 24px;
        }
        
        .play-button[data-symbol="⏸"]::after {
            transform: translate(calc(-50% + 1px), calc(-50% - 2px));
            font-size: 28px;
        }
        
        
        .play-button.playing {
            background-image: url('Image_Sources/spotplay.png');
        }
        
        .play-button.paused {
            background-image: url('Image_Sources/spotplay.png');
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            color: white;
            z-index: 2000;
        }

        .legend {
            margin: 0;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            margin: 0;
            display: flex;
            align-items: center;
            white-space: nowrap;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #fff;
        }
        
        /* Left sidebar for charts - responsive layout */
        .charts-sidebar {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            width: 35vw;
            max-width: 650px;
            min-width: 320px;
            height: 70vh;
            max-height: 550px;
            background: linear-gradient(180deg, #181818 0%, #121212 100%);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            z-index: 1000;
            border: 1px solid #282828;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .charts-header {
            padding: 15px 20px;
            border-bottom: 1px solid #282828;
            background: #181818;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .charts-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chart-counter {
            color: #b3b3b3;
            font-size: 14px;
        }
        
        .chart-display {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .chart-display::-webkit-scrollbar {
            display: none;
        }
        
        .chart-section {
            height: 100%; /* Fill the chart-display container height */
            scroll-snap-align: start; /* Back to start alignment for precise snapping */
            scroll-snap-stop: always;
            display: flex;
            flex-direction: column;
            padding: 8px; /* Reduced from 15px */
            position: relative;
            align-items: stretch;
            text-align: left;
            overflow: hidden; /* Prevent content from other slides showing */
            box-sizing: border-box; /* Include padding in height calculation */
        }
        
        
        .chart-title {
            color: #fff;
            font-size: 18px; /* Smaller font */
            font-weight: bold;
            margin-bottom: 6px; /* Match paragraph spacing */
            text-align: center;
            height: 30px; /* Reduced height */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-container {
            flex: none; /* Don't expand to fill space */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            height: 220px; /* Reduced from 280px */
            margin: 6px 0; /* Match paragraph spacing */
        }
        
        .chart-image {
            width: 90%;
            height: auto;
            max-height: 260px; /* Fixed max height */
            border-radius: 12px; /* More rounded corners */
            border: none; /* Remove image borders */
            object-fit: contain;
            transition: transform 0.3s ease, opacity 0.3s ease;
            background: transparent;
        }
        
        .chart-section:not(.active) .chart-image {
            transform: scale(0.95);
            opacity: 0.7;
        }
        
        .chart-section.active .chart-image {
            transform: scale(1);
            opacity: 1;
        }
        
        .scroll-instructions {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        
        .chart-progress {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(179, 179, 179, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .progress-dot.active {
            background: #1db954;
            transform: scale(1.2);
        }
        
        /* Story content styling */
        .story-content {
            color: #b3b3b3;
            line-height: 1.4; /* Tighter line height */
            font-size: 14px; /* Smaller font */
            padding: 6px 30px; /* Much more horizontal padding to avoid edge hugging */
        }
        
        .story-content p {
            margin-bottom: 6px; /* Further reduced for ultra-compact layout */
        }
        
        /* Tighter spacing when story content comes before chart */
        .story-content + .chart-container {
            margin-top: -5px; /* Negative margin to pull chart closer */
        }
        
        /* Remove bottom padding from story content when followed by chart */
        .has-chart .story-content {
            padding-bottom: 0px; /* Remove bottom padding for tighter spacing */
        }
        
        /* Remove margin from last element in story content for even tighter spacing */
        .story-content p:last-child,
        .story-content div:last-child {
            margin-bottom: 0px;
        }
        
        /* Better spacing for chart slides 5-8 */
        .chart-section[data-section="5"] .chart-container,
        .chart-section[data-section="6"] .chart-container,
        .chart-section[data-section="7"] .chart-container,
        .chart-section[data-section="8"] .chart-container {
            margin: 12px 0; /* Increased from 6px for more breathing room */
        }
        
        .chart-section[data-section="5"] .chart-title,
        .chart-section[data-section="6"] .chart-title,
        .chart-section[data-section="7"] .chart-title,
        .chart-section[data-section="8"] .chart-title {
            margin-bottom: 10px; /* Increased from 6px */
        }
        
        .chart-section[data-section="5"] .story-content,
        .chart-section[data-section="6"] .story-content,
        .chart-section[data-section="7"] .story-content,
        .chart-section[data-section="8"] .story-content {
            padding: 10px 30px; /* Much more horizontal padding to avoid edge hugging */
        }
        
        .story-content strong {
            color: #ffffff;
        }
        
        .story-content ol, .story-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .story-content li {
            margin-bottom: 6px;
        }
        
        .data-highlight {
            background: rgba(29, 185, 84, 0.15);
            border-left: 3px solid #1db954;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 3px;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
        }
        
        .ace-info {
            background: rgba(255, 165, 0, 0.15);
            border-left: 3px solid #ffa500;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 3px;
        }
        
        .finding-box {
            background: rgba(220, 20, 60, 0.15);
            border-left: 3px solid #dc143c;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 3px;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
        }
        
        .data-note {
            background: rgba(128, 128, 128, 0.15);
            border-left: 3px solid #808080;
            padding: 6px 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 12px;
            font-style: italic;
            display: inline-block;
            width: fit-content;
            max-width: 100%;
        }
        
        .solutions-list {
            margin: 15px 0;
        }
        
        .solution-item {
            background: rgba(40, 40, 40, 0.4);
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            border: 1px solid #444;
        }
        
        .solution-item p {
            margin: 6px 0 0 0;
            font-size: 13px;
        }
        
        .conclusion-summary {
            background: rgba(50, 50, 50, 0.4);
            padding: 10px 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #555;
        }
        
        .conclusion-summary h4 {
            margin: 0 0 8px 0;
            color: #fff;
        }
        
        .next-steps {
            background: rgba(0, 100, 0, 0.15);
            border-left: 3px solid #008000;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 3px;
        }
        
        /* Smaller text for sections 11-13 to fit charts better */
        .chart-section[data-section="11"] .story-content,
        .chart-section[data-section="12"] .story-content,
        .chart-section[data-section="13"] .story-content {
            font-size: 12px;
            line-height: 1.3;
            padding: 4px 25px;
        }
        
        .chart-section[data-section="11"] .story-content p,
        .chart-section[data-section="12"] .story-content p,
        .chart-section[data-section="13"] .story-content p {
            margin-bottom: 4px;
        }
        
        .chart-section[data-section="11"] .data-highlight,
        .chart-section[data-section="12"] .data-highlight,
        .chart-section[data-section="13"] .data-highlight {
            padding: 6px 10px;
            margin: 6px 0;
        }
        
        /* Add more space between title and content for slide 9 */
        .chart-section[data-section="9"] .story-content {
            margin-top: 15px;
            padding: 10px 30px;
        }
        
        .chart-section[data-section="9"] .chart-container {
            margin-top: 15px;
        }
        
        /* Increase image size and position lower for slide 12 */
        .chart-section[data-section="12"] .chart-image {
            width: 85%;
            max-height: 220px;
        }
        
        .chart-section[data-section="12"] .chart-container {
            height: 250px;
            margin-top: 20px;
            align-items: flex-end;
        }
        
        /* Shrink image size for slide 13 to prevent covering text */
        .chart-section[data-section="13"] .chart-image {
            width: 70%;
            max-height: 180px;
        }
        
        .chart-section[data-section="13"] .chart-container {
            height: 200px;
        }
        
        /* Increase image size and position lower for slide 14 */
        .chart-section[data-section="14"] .chart-image {
            width: 85%;
            max-height: 220px;
        }
        
        .chart-section[data-section="14"] .chart-container {
            height: 250px;
            margin-top: 20px;
            align-items: flex-end;
        }
        
        /* Position image closer to bottom and center for slide 11 */
        .chart-section[data-section="11"] .chart-container {
            margin-top: 15px;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: 150px;
        }
        
        .chart-section[data-section="11"] .chart-image {
            margin-top: 10px;
        }
        
        /* Make Top 20 violators image bigger and centered for slide 8 */
        .chart-section[data-section="8"] .chart-container {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .chart-section[data-section="8"] .chart-image {
            width: 95%;
            max-height: 320px;
            object-fit: contain;
        }
        
        /* Increase picture size and center for slide 13 */
        .chart-section[data-section="13"] .chart-container {
            height: 280px;
            margin-top: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-section[data-section="13"] .chart-image {
            width: 90%;
            max-height: 250px;
            object-fit: contain;
        }
        
        /* Reduce text size and ensure image fits for slide 14 */
        .chart-section[data-section="14"] .story-content {
            font-size: 12px;
            line-height: 1.3;
            padding: 4px 25px;
        }
        
        .chart-section[data-section="14"] .story-content p {
            margin-bottom: 4px;
        }
        
        .chart-section[data-section="14"] .data-highlight {
            padding: 6px 10px;
            margin: 6px 0;
            font-size: 11px;
        }
        
        .chart-section[data-section="14"] .chart-image {
            width: 80%;
            max-height: 200px;
            object-fit: contain;
        }
        
        .chart-section[data-section="14"] .chart-container {
            height: 240px;
            margin-top: 15px;
            align-items: flex-start;
        }
        
        /* Reduce text size and image size for slide 15 */
        .chart-section[data-section="15"] .story-content {
            font-size: 12px;
            line-height: 1.3;
            padding: 4px 25px;
        }
        
        .chart-section[data-section="15"] .story-content p {
            margin-bottom: 4px;
        }
        
        .chart-section[data-section="15"] .data-highlight {
            padding: 6px 10px;
            margin: 6px 0;
            font-size: 11px;
        }
        
        .chart-section[data-section="15"] .chart-image {
            width: 85%;
            max-height: 220px;
            object-fit: contain;
        }
        
        .chart-section[data-section="15"] .chart-container {
            height: 250px;
            margin-top: 15px;
            align-items: center;
            justify-content: center;
        }
        
        /* Increase text size for slide 16 */
        .chart-section[data-section="16"] .story-content {
            font-size: 16px;
            line-height: 1.5;
            padding: 8px 30px;
        }
        
        .chart-section[data-section="16"] .story-content p {
            margin-bottom: 8px;
        }
        
        /* Make proposed solutions text smaller for slide 11 */
        .chart-section[data-section="11"] .story-content {
            font-size: 11px;
            line-height: 1.3;
        }
        
        .chart-section[data-section="11"] .story-content p {
            margin-bottom: 4px;
        }
        
        .chart-section[data-section="11"] .solution-item {
            margin: 5px 0;
            padding: 5px 8px;
        }
        
        .chart-section[data-section="11"] .solution-item p {
            font-size: 11px;
            margin: 3px 0;
        }
        
        .scroll-hint {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: #888;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Mapbox popup dark theme and minimal border */
        .mapboxgl-popup {
            z-index: 1500;
        }

        .mapboxgl-popup-content {
            background: rgba(0,0,0,0.7); /* semi-transparent dark background */
            color: #ffffff;
            border: 0; /* remove white border entirely */
            padding: 10px 12px; /* compact */
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }

        .mapboxgl-popup-close-button {
            color: #cccccc;
        }

        /* Ensure the popup tip matches the semi-transparent dark background for all anchors */
        .mapboxgl-popup-tip {
            border-top-color: rgba(0,0,0,0.7) !important;
            border-bottom-color: rgba(0,0,0,0.7) !important;
            border-left-color: rgba(0,0,0,0.7) !important;
            border-right-color: rgba(0,0,0,0.7) !important;
        }
        
        /* Album cover style GIF in bottom left */
        .album-cover {
            position: fixed;
            bottom: 5px;
            left: 15px;
            width: 90px;
            height: 90px;
            border-radius: 8px;
            z-index: 1500;
            transition: transform 0.3s ease, opacity 0.5s ease;
            opacity: 0;
            display: none;
        }
        
        .album-cover:hover {
            transform: scale(1.05);
        }
        
        .album-cover img {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            object-fit: cover;
            border: none;
        }
        
        .album-cover.show {
            opacity: 1;
            display: block;
        }
        
        /* Analysis toggle button - same size as prev/next buttons */
        .nav-button.analysis-toggle {
            width: 67px;
            height: 67px;
            background-size: 30px 30px;
            margin-right: -15px; /* Close gap to previous button - 15px apart */
        }
        
        /* Override default gray filter only when showing enabled icon */
        .nav-button.analysis-toggle[style*="analysis_enabled.png"] {
            filter: none !important;
        }
        
        /* Force analysis toggle button size with higher specificity */
        button.nav-button.analysis-toggle {
            width: 67px !important;
            height: 67px !important;
            background-size: 30px 30px !important;
        }
        
        /* Loop button - almost as big as prev/next buttons */
        .nav-button.loop {
            width: 60px;
            height: 60px;
            background-size: 28px 28px;
            margin-right: -20px; /* Bring loop button closer to speed button */
            margin-left: -5px; /* Move 5px to the left */
        }
        
        /* Speed button - same size as prev/next buttons */
        .nav-button.speed {
            width: 67px;
            height: 67px;
            font-size: 16px;
            font-weight: 700;
            margin-left: -5px; /* Move 5px to the left */
        }
        
        /* Increase previous and next button sizes to 140% of play button (67px) */
        .nav-button.prev,
        .nav-button.next {
            width: 67px;
            height: 67px;
            background-size: 30px 30px; /* Scale icon proportionally */
        }
        
        /* Floating legend in bottom right */
        .floating-legend {
            position: fixed;
            bottom: 110px;
            right: 20px;
            background: rgba(24, 24, 24, 0.9);
            border: 1px solid #282828;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1500;
            backdrop-filter: blur(10px);
        }
        
        
    </style>
</head>
<body>
    <div id='map'></div>
    <div id="loading" class="loading">Loading crash and ACE data...</div>
    
    <!-- Album Cover GIF -->
    <div class="album-cover">
        <img src="Image_Sources/DISC.gif" alt="Animated disc">
    </div>
    
    <!-- Floating Legend -->
    <div class="floating-legend">
        <div class="legend-item">
            <div style="background: linear-gradient(90deg, #4169e1, #ffd700, #dc143c); width: 20px; height: 4px; border-radius: 2px;"></div>
            <span style="color: #b3b3b3; font-size: 9px;">Crashes</span>
        </div>
        <div class="legend-item">
            <div style="background: linear-gradient(90deg, #8a2be2, #ff1493); width: 20px; height: 4px; border-radius: 2px;"></div>
            <span style="color: #b3b3b3; font-size: 9px;">ACE</span>
        </div>
        <div class="legend-item">
            <div style="background: #FFD700; width: 10px; height: 10px; border-radius: 2px; opacity: 0.8;"></div>
            <span style="color: #b3b3b3; font-size: 9px;">Congestion Zone</span>
        </div>
        <div class="legend-item">
            <div style="background: #FF6B6B; width: 16px; height: 3px; border-radius: 1px;"></div>
            <span style="color: #b3b3b3; font-size: 9px;">ACE Routes</span>
        </div>
        <div class="legend-item">
            <div style="background: #0066CC; width: 16px; height: 3px; border-radius: 1px;"></div>
            <span style="color: #b3b3b3; font-size: 9px;">Non-ACE Routes</span>
        </div>
    </div>
    
    <!-- Story Sidebar -->
    <div class="charts-sidebar" id="story-sidebar">
        <div class="charts-header">
            <h3><img src="Image_Sources/MTA_NYC_logo.svg.png" alt="MTA Logo" style="height: 20px; width: auto; margin-right: 8px; vertical-align: middle;">NYC Bus ACE Analysis</h3>
            <div class="chart-counter" id="section-counter">1 / 18</div>
        </div>
        <div class="chart-display" id="story-display">
            <!-- Section 1: Introduction -->
            <div class="chart-section active" data-section="1">
                <div class="chart-title">NYC Bus System & ACE</div>
                <div class="story-content">
                    <p>The New York City bus system serves over a million riders per day. Despite this, the system is plagued with delays and crawling speeds, partially due to illegally parked vehicles obstructing the buses' path.</p>
                    <p>One method employed by the MTA to combat this is <strong>Automated Camera Enforcement (ACE)</strong>.</p>
                    <p><strong>Three key questions:</strong></p>
                    <ol>
                        <li>What is the recidivism rate of ticketed vehicles?</li>
                        <li>How has ACE affected bus speeds vs non-ACE routes?</li>
                        <li>Has ACE reduced accidents?</li>
                    </ol>
                    <div class="scroll-hint">↓ Scroll to explore our analysis</div>
                </div>
            </div>
            
            <!-- Section 2: What is ACE -->
            <div class="chart-section" data-section="2">
                <div class="chart-title">What is ACE?</div>
                <div class="story-content">
                    <p>ACE is the MTA's automated camera enforcement system. In mid-2024, the existing ABLE ticketing system was expanded into ACE.</p>
                    <p><strong>ABLE</strong> (Automated Bus Lane Enforcement) only ticketed vehicles blocking bus lanes or stops.</p>
                    <p><strong>ACE expanded</strong> to include double-parked and other illegally parked vehicles.</p>
                    <div class="ace-info">
                        <strong>How it works:</strong> If two buses record a vehicle engaging in illegal parking behavior more than 5 minutes apart, the vehicle receives a $50 ticket. Each subsequent ticket increases by $50 until reaching the $250 cap.
                    </div>
                </div>
            </div>
            
            <!-- Section 3: ACE Categories -->
            <div class="chart-section" data-section="3">
                <div class="chart-title">Ticketing Recidivism</div>
                <div class="story-content">
                    <p><strong>ACE violations are broken down into 7 categories:</strong></p>
                    <ol>
                        <li>Violation Issued</li>
                        <li>Exempt: Emergency Vehicle</li>
                        <li>Exempt: Small Commercial Vehicle</li>
                        <li>Exempt: Bus/Paratransit Service</li>
                        <li>Exempt: Other</li>
                        <li>Driver/Vehicle Info Missing (no ticket)</li>
                        <li>Technical Issue/Other (no ticket)</li>
                    </ol>
                    <p><em>For analysis, exempt categories are generally grouped together.</em></p>
                </div>
            </div>
            
            <!-- Section 4: Basic ACE Data -->
            <div class="chart-section has-chart" data-section="4">
                <div class="chart-title">Basic ACE Statistics</div>
                <div class="story-content">
                    <div class="data-highlight">
                        <strong>Key Finding:</strong> Over 1 million unique cars received violations, with 2.3 million total tickets issued.
                    </div>
                    <p>The median and mode is 1 ticket per vehicle, but the mean is 2.26 - indicating a <strong>small group of repeat offenders</strong> driving up the average.</p>
                    <p>Emergency vehicles and Paratransit have significantly higher averages (13.3 and 7.7 tickets respectively), suggesting <strong>structural issues</strong> in city space allocation.</p>
                </div>
                <div class="chart-container">
                    <img src="Data_Tables/BasicAceData.jpg" alt="Basic ACE Statistics" class="chart-image">
                </div>
            </div>
            
            <!-- Section 5: Vehicle Distribution Chart -->
            <div class="chart-section has-chart" data-section="5">
                <div class="chart-title">Vehicle Ticket Distribution</div>
                <div class="chart-container">
                    <img src="Data_Tables/PercentofVechiles recievingof tickets.png" alt="Vehicle Ticket Distribution" class="chart-image">
                </div>
                <div class="story-content">
                    <p><strong>60.1%</strong> of vehicles received only one ticket</p>
                    <p><strong>2.4%</strong> of vehicles received more than 10 tickets</p>
                    <p>For exempt vehicles: <strong>11%</strong> received over 10 violations</p>
                </div>
            </div>
            
            <!-- Section 6: Violations Distribution -->
            <div class="chart-section has-chart" data-section="6">
                <div class="chart-title">Ticket Distribution Analysis</div>
                <div class="chart-container">
                    <img src="Data_Tables/Recidivism Violation.png" alt="Recidivism Violations" class="chart-image">
                </div>
                <div class="story-content">
                    <div class="data-highlight">
                        Despite only <strong>2.4%</strong> of vehicles receiving 10+ tickets, they account for <strong>19.7%</strong> of all tickets issued.
                    </div>
                    <p>Almost half of all tickets went to vehicles with 4+ prior tickets, despite being only 13.6% of total vehicles.</p>
                </div>
            </div>
            
            <!-- Section 7: Exempt Violations -->
            <div class="chart-section has-chart" data-section="7">
                <div class="chart-title">Exempt Vehicle Analysis</div>
                <div class="chart-container">
                    <img src="Data_Tables/Recidivism Exempt.png" alt="Exempt Recidivism" class="chart-image">
                </div>
                <div class="story-content">
                    <div class="data-highlight">
                        <strong>66.9%</strong> of all exempt violations were given to vehicles with 10+ prior instances.
                    </div>
                    <p>This indicates <strong>structural issues</strong> in the city regarding space allocation as Paratransit, commercial, and emergency vehicles are forced into violating parking laws.</p>
                </div>
            </div>
            
            <!-- Section 8: Top Violators -->
            <div class="chart-section has-chart" data-section="8">
                <div class="chart-title">Top 20 Violators</div>
                <div class="chart-container">
                    <img src="Data_Tables/Top 20 violators.png" alt="Top 20 Violators" class="chart-image">
                </div>
            </div>
            
            <!-- Section 9: Monthly Trends -->
            <div class="chart-section has-chart" data-section="9">
                <div class="chart-title">Violations by Route & Month</div>
                <div class="chart-container">
                    <img src="Data_Tables/Violations Issued of Select Charts.png" alt="Monthly Violations" class="chart-image">
                </div>
                <div class="story-content">
                    <p><strong>Pattern observed:</strong> Spike in tickets May-September 2024 (ABLE to ACE transition) and March-April 2025 (ACE expansion).</p>
                    <p><strong>BX19 and M101</strong> have the highest number of tickets by far.</p>
                </div>
            </div>
            
            <!-- Section 10: Exempt Vehicle Patterns -->
            <div class="chart-section has-chart" data-section="10">
                <div class="chart-title">Exempt Vehicle Patterns</div>
                <div class="chart-container">
                    <img src="Data_Tables/Exempt of Select Chart.png" alt="Exempt Vehicle Violations by Route" class="chart-image">
                </div>
                <div class="story-content">
                    <p>The exempt data is similar in its spikes but not in the trough. This is likely because they are (rightfully) not punished for violations and further confirms a structural issue.</p>
                </div>
            </div>
            
            <!-- Section 11: Solutions -->
            <div class="chart-section" data-section="11">
                <div class="chart-title">Solutions</div>
                <div class="story-content">
                    <p>These results are similar to speed camera data. There is a small portion of <strong>"super speeders"</strong> that contribute a disproportionate number of violations. We can look to proposed speeding solutions and apply them here.</p>
                    <p>Potential solutions require changes to the fine structure, passage of state laws, and partnership with the DOT.</p>
                    <p><strong>We propose:</strong></p>
                    <div class="solutions-list">
                        <div class="solution-item">
                            <strong>Harsher Fines</strong>
                            <p>The 5th fine is the same value as the 105th fine. The $250 cap should be raised to further disincentivize illegal behavior.</p>
                            <p>MTA should partner with NYPD to further crack down on unpaid tickets.</p>
                        </div>
                        <div class="solution-item">
                            <strong>Vehicle Modification Through State Law</strong>
                            <p>Currently, a "super speeder" bill has been proposed in the state legislature that would impose harsher penalties on frequent offenders. A similar bill could be adopted.</p>
                        </div>
                        <div class="solution-item">
                            <strong>Street Redesigns</strong>
                            <p>MTA should further its partnership with DOT by dedicating more street space along highly fined routes (BX19, M101, BX36) to the exempt usages.</p>
                            <p>A certain number of parking spots along commercial corridors should be dedicated commercial loading zones.</p>
                            <p>Emergency vehicle only lanes should be created on certain wide streets, especially where respond times are long and potentially life threatening. This removes vehicles from conflicting with buses.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 12: Impact on Speed -->
            <div class="chart-section has-chart" data-section="12">
                <div class="chart-title">Impact on Speed</div>
                <div class="story-content">
                    <p>To assess the impact of ACE, we examined speed changes along ACE bus routes and compared them to several benchmarks: ACE routes before implementation, non-ACE routes to test for system-wide effects, and routes within the Central Business District (CBD) subject to congestion pricing to capture their combined influence.</p>
                    <div class="data-highlight">
                        <strong>Key Finding:</strong> Both congestion pricing and ACE improve bus speeds, and their benefits are cumulative. However, congestion pricing exerts a stronger effect on overall bus performance.
                    </div>
                </div>
                <div class="chart-container">
                    <img src="Data_Tables/ACEChangeinspeed.png" alt="ACE Speed Change Analysis" class="chart-image">
                </div>
            </div>
            
            <!-- Section 13: ACE Speed Analysis -->
            <div class="chart-section has-chart" data-section="13">
                <div class="chart-title">ACE Speed Improvements</div>
                <div class="story-content">
                    <p>This time-series chart shows the percent change in speed across the aggregate of all 43 ACE routes from before ACE was implemented on the route to after. The middle 0 point is when ACE was implemented.</p>
                    <div class="data-highlight">
                        The line dips just before implementation but quickly climbs afterward, averaging around a <strong>4-5% gain in speed</strong>.
                    </div>
                    <p>This implies ACE is correlated with faster bus speeds that sustain for almost a year. The drop off at the 10-month mark is likely due to data and coding-related issues rather than sharp speed declines. However, we still need to compare it to non-ACE routes.</p>
                </div>
                <div class="chart-container">
                    <img src="Data_Tables/Change in MPH from 2019 Baseline.png" alt="Change in MPH from 2019 Baseline" class="chart-image">
                </div>
            </div>
            
            <!-- Section 14: Non-ACE Route Deep Analysis -->
            <div class="chart-section has-chart" data-section="14">
                <div class="chart-title">Non-ACE Route Deep Analysis</div>
                <div class="story-content">
                    <p>To deepen the analysis of ACE and congestion pricing, we randomly selected six non-ACE bus routes: three within the congestion zone and three in Brooklyn, outside the zone. The results reveal a clear divide.</p>
                    <div class="data-highlight">
                        All three congestion-zone routes show notable speed gains, with the M12 improving by more than 0.15 mph. By contrast, all three Brooklyn routes experienced considerable speed declines.
                    </div>
                    <p>This pattern suggests that congestion pricing effectively reduced traffic volumes in the CBD, leading to faster bus travel.</p>
                    <p>Importantly, these findings do not imply that traffic was simply displaced elsewhere. The B1 and B100 corridors are located far from the CBD and do not directly intersect with it, making it unlikely that congestion shifted to those areas. Instead, the data points toward congestion pricing having a localized effect: easing traffic within the CBD without producing offsetting increases in peripheral corridors.</p>
                </div>
                <div class="chart-container">
                    <img src="Data_Tables/pre-post congestion on non ace.png" alt="Pre-Post Congestion on Non-ACE Routes" class="chart-image">
                </div>
            </div>
            
            <!-- Section 15: Route Comparison Analysis -->
            <div class="chart-section has-chart" data-section="15">
                <div class="chart-title">Route Comparison Analysis</div>
                <div class="story-content">
                    <p>We analyzed six non-ACE bus routes: three within the congestion zone and three in Brooklyn. We also examined three CBD routes without ACE until later in the year.</p>
                    <div class="data-highlight">
                        <strong>Key Findings:</strong> All congestion-zone routes show speed gains (M12 +0.15 mph, M42 +0.07 mph), while Brooklyn routes experienced declines.
                    </div>
                    <p>This confirms congestion pricing effectively reduced CBD traffic without displacing it to peripheral areas.</p>
                </div>
                <div class="chart-container">
                    <img src="Data_Tables/pre and post ace routes in congestion.png" alt="Pre and Post ACE Routes in Congestion Zone" class="chart-image">
                </div>
            </div>
            
            <!-- Section 16: Did ACE Reduce Accidents? -->
            <div class="chart-section" data-section="16">
                <div class="chart-title">Did ACE Reduce Accidents?</div>
                <div class="story-content">
                    <p>We analyzed the impact of ACE on car accidents and fatalities.</p>
                    <p><strong>Hypothesis:</strong> ACE expansion would have a noticeable reduction in the number of car crashes and fatalities.</p>
                    <p>Red light and speeding cameras, other forms of automated enforcement, have been proven to reduce crashes. We hypothesized a similar effect from ACE.</p>
                </div>
            </div>
            
            <!-- Section 17: Accident Analysis Results -->
            <div class="chart-section" data-section="17">
                <div class="chart-title">Accident Analysis Results</div>
                <div class="story-content">
                    <div class="finding-box">
                        <strong>Finding:</strong> Our data shows ACE has <strong>minimal, if any, impact</strong> on accidents.
                    </div>
                    <p>Illegal parking does not seem to have the dangerous effect on roads that speeding or red light violations do, which is understandable. Speeding inherently makes crashes more dangerous and red light violations inherently raise the chance of a crash.</p>
                    <p><strong>Illegal parking makes roads less efficient, potentially slowing down speeds.</strong></p>
                    <p>However, our analysis is incomplete. Perhaps as all forms of traffic recovered from COVID accidents would've risen if ACE was not in place. Further research is needed.</p>
                </div>
            </div>
            
            <!-- Section 18: Conclusion -->
            <div class="chart-section" data-section="18">
                <div class="chart-title">Conclusion</div>
                <div class="story-content">
                    <div class="conclusion-summary">
                        <h4>Key Findings:</h4>
                        <ul>
                            <li>High recidivism among small group of "super parkers"</li>
                            <li>Structural issues force exempt vehicles into violations</li>
                            <li>ACE improves bus efficiency with 4-5% speed gains</li>
                            <li>Congestion pricing shows stronger effect than ACE alone</li>
                            <li>ACE has minimal impact on accident reduction</li>
                            <li>Solutions require policy changes and street redesigns</li>
                        </ul>
                    </div>
                    <div class="next-steps">
                        <strong>Further research needed:</strong> Post-COVID traffic recovery analysis and long-term ACE effectiveness studies.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress indicators -->
        <div class="chart-progress" id="progress-dots">
            <!-- Dots will be generated by JavaScript -->
        </div>
    </div>
    
    <div class="unified-panel" style="display: none;" id="control-panel">
        <!-- Top Row: Main Controls -->
        <div class="temporal-section">
            <!-- Left: Date and Data Info -->
            <div style="display: flex; flex-direction: column; gap: 3px; min-width: 200px;">
                <div class="month-display" id="month-display">Loading...</div>
                <div style="display: flex; gap: 8px; font-size: 10px; color: #b3b3b3;">
                    <div class="crash-count" id="crash-count">Loading...</div>
                    <span style="color: #535353;">•</span>
                    <div class="ace-count" id="ace-count">Loading...</div>
                </div>
            </div>
            
            <!-- Center: Play Controls -->
            <div class="play-controls">
                <div class="left-controls">
                    <button class="nav-button analysis-toggle" id="analysis-toggle" title="Hide Analysis Panel"></button>
                    <button class="nav-button prev" onclick="previousMonth()"></button>
                </div>
                <div class="center-control">
                    <button id="play-button" class="play-button" data-symbol="▶" onclick="toggleAnimation()"></button>
                </div>
                <div class="right-controls">
                    <button class="nav-button next" onclick="nextMonth()"></button>
                    <button id="loop-button" class="nav-button loop" onclick="toggleLoop()" title="Toggle Loop"></button>
                    <button id="speed-button" class="nav-button speed" onclick="toggleSpeed()" title="Playback Speed: 1x">1x</button>
                </div>
            </div>
            
            <!-- Right: Controls -->
            <div style="display: flex; flex-direction: column; align-items: flex-end; min-width: 250px;">
                <!-- Route Coloring (aligned above toggleable layers) -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; align-self: flex-start;">
                    <span style="font-size: 10px; color: #ffffff; font-weight: 600;">Route Mode</span>
                    <div class="triple-route-slider">
                        <span class="route-mode-label">Bus</span>
                        <div class="route-mode-container mode-0" id="route-mode-slider" onclick="cycleRouteMode()">
                            <div class="route-mode-indicator"></div>
                        </div>
                        <span class="route-mode-label">ACE Only</span>
                    </div>
                </div>
                
                <!-- Toggleable Layers -->
                <div class="data-toggle">
                    <div style="font-size: 10px;">Toggleable Layers</div>
                    <div class="toggle-buttons" style="gap: 4px;">
                        <button id="crashes-toggle" onclick="toggleCrashes()" style="font-size: 9px; padding: 5px 10px;">Crashes</button>
                        <button id="ace-toggle" onclick="toggleACE()" style="font-size: 9px; padding: 5px 10px;">Tickets</button>
                        <button id="transit-toggle" class="active" onclick="toggleTransit()" style="font-size: 9px; padding: 5px 10px;">Routes</button>
                        <button id="stops-toggle" onclick="toggleStops()" style="font-size: 9px; padding: 5px 10px;">Bus Stops</button>
                        <button id="congestion-toggle" class="active" onclick="toggleCongestionZone()" style="font-size: 9px; padding: 5px 10px; min-width: 70px;">Congestion</button>
                    </div>
                </div>
                
                <!-- Opacity Control -->
                <div class="opacity-control">
                    <label for="opacity-slider" style="display: flex; align-items: center; gap: 4px;">
                        <img src="Image_Sources/opacity.png" alt="Opacity" style="width: 12px; height: 12px; filter: brightness(0) invert(1);">
                        <span style="font-size: 10px;">Opacity</span>
                    </label>
                    <input type="range" min="10" max="100" value="100" class="opacity-slider" id="opacity-slider" oninput="updateOpacity(this.value)">
                    <span class="opacity-value" id="opacity-value">100%</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row: Progress Slider -->
        <div class="slider-container">
            <div class="slider-date-label" id="slider-start-date">Sep 2024</div>
            <input type="range" min="0" max="100" value="0" class="time-slider" id="time-slider">
            <div class="slider-date-label" id="slider-end-date">Dec 2023</div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let config;
        let combinedData = null;
        let transitData = null;
        let currentMonthIndex = 0;
        let animationId = null;
        let isPlaying = false;
        let currentViewMode = 'heatmap';
        let showCrashes = false; // Start disabled
        let showACE = false; // Start disabled - renamed to Tickets
        let showTransit = true;
        let showStops = false; // Start disabled
        let showCongestionZone = true;
        let routeMode = 0; // 0 = Bus Routes, 1 = ACE Mode, 2 = ACE Only
        let globalOpacity = 1.0; // Global opacity for all map layers
        let isLoopEnabled = false; // Timeline loop toggle
        let playbackSpeed = 1; // Playback speed multiplier: 1x, 2x, 4x
        let sliderAnimationId = null; // For smooth slider animation
        let userInteracting = false; // Track if user is manually adjusting slider
        let previousPlaybackSpeed = 1; // Store speed before section 3
        let autoAnimationActive = false; // Track if auto-animation is running
        let analysisPanelVisible = true; // Analysis panel starts visible

        // Initialize the application
        async function initApp() {
            try {
                // Load configuration and combined data
                console.log('Loading configuration...');
                const configResponse = await fetch('config.json');
                
                if (!configResponse.ok) {
                    throw new Error(`Config fetch failed: ${configResponse.status} ${configResponse.statusText}`);
                }
                
                config = await configResponse.json();
                console.log('✅ Config loaded successfully');
                
                console.log('Loading crash and ACE data...');
                const dataResponse1 = await fetch('data_part1.json');
                
                if (!dataResponse1.ok) {
                    throw new Error(`Data part 1 fetch failed: ${dataResponse1.status} ${dataResponse1.statusText}`);
                }
                
                const part1Data = await dataResponse1.json();
                console.log('✅ Part 1 data loaded successfully');
                
                console.log('Loading transit data...');
                const dataResponse2 = await fetch('data_part2.json');
                
                if (!dataResponse2.ok) {
                    throw new Error(`Data part 2 fetch failed: ${dataResponse2.status} ${dataResponse2.statusText}`);
                }
                
                const part2Data = await dataResponse2.json();
                console.log('✅ Part 2 data loaded successfully');
                
                // Combine the data
                combinedData = {
                    crash_data: part1Data.crash_data,
                    ace_data: part1Data.ace_data,
                    transit_data: part2Data.transit_data
                };
                transitData = combinedData.transit_data;
                console.log('✅ Combined data assembled successfully');
                
                // Initialize map
                initMap();
                
                // Setup UI
                setupUI();
                
                console.log('✅ Application initialized successfully');
                
            } catch (error) {
                console.error('❌ Failed to load data:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ff6b6b; max-width: 400px;">
                        <h3>Failed to load data</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure you have run the ACE+Crash data generation script first.</p>
                    </div>
                `;
            }
        }

        function initMap() {
            mapboxgl.accessToken = config.mapbox_token;
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: config.map_center,
                zoom: config.map_zoom,
                maxBounds: config.map_bounds,
                minZoom: config.min_zoom,
                maxZoom: 22,
                maxPitch: 0,
                dragRotate: false
            });

            map.on('load', () => {
                console.log('Map loaded successfully');
                setupMapLayers();
                
                // Now that map is loaded, update visualization and show controls
                updateVisualization(false); // Don't smooth on initial load
                
                // Initialize story navigation
                initStoryNavigation();
                
                // Hide loading screen and show controls
                document.getElementById('loading').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                
                // Show album cover after everything is loaded
                setTimeout(() => {
                    const albumCover = document.querySelector('.album-cover');
                    if (albumCover) {
                        albumCover.classList.add('show');
                    }
                    
                    // Initialize analysis toggle button (panel starts visible)
                    const analysisToggle = document.getElementById('analysis-toggle');
                    if (analysisToggle) {
                        analysisToggle.style.backgroundImage = "url('Image_Sources/analysis_enabled.png')";
                        analysisToggle.style.backgroundColor = 'transparent';
                        analysisToggle.style.backgroundSize = '16px 16px';
                        analysisToggle.style.backgroundRepeat = 'no-repeat';
                        analysisToggle.style.backgroundPosition = 'center';
                        analysisToggle.style.filter = '';
                        analysisToggle.title = 'Hide Analysis Panel';
                    }
                }, 500);
            });
        }

        function deduplicateBusStops(busStopsData) {
            // Safety check
            if (!busStopsData || !busStopsData.features || !Array.isArray(busStopsData.features)) {
                console.warn('Invalid bus stops data, returning original data');
                return busStopsData;
            }
            
            const nameMap = new Map();
            const deduplicatedFeatures = [];
            
            try {
                busStopsData.features.forEach(feature => {
                    const stopName = feature.properties.stop_name;
                    
                    if (!stopName) {
                        // If no stop name, keep it
                        deduplicatedFeatures.push(feature);
                        return;
                    }
                    
                    if (!nameMap.has(stopName)) {
                        // First occurrence of this stop name
                        nameMap.set(stopName, feature);
                        deduplicatedFeatures.push(feature);
                    } else {
                        // Duplicate name found - merge route information with existing stop
                        const existing = nameMap.get(stopName);
                        
                        try {
                            const existingRoutes = JSON.parse(existing.properties.routes_served || '[]');
                            const newRoutes = JSON.parse(feature.properties.routes_served || '[]');
                            const combinedRoutes = [...new Set([...existingRoutes, ...newRoutes])];
                            
                            existing.properties.routes_served = JSON.stringify(combinedRoutes);
                        } catch (e) {
                            console.warn('Error merging route data for duplicate stop:', stopName, e);
                        }
                        // Skip adding this duplicate feature to deduplicatedFeatures
                    }
                });
                
                console.log(`Deduplicated bus stops by name: ${busStopsData.features.length} → ${deduplicatedFeatures.length}`);
                
                return {
                    type: 'FeatureCollection',
                    features: deduplicatedFeatures
                };
            } catch (error) {
                console.error('Error in deduplicateBusStops:', error);
                return busStopsData; // Return original data if there's an error
            }
        }
        
        function setupMapLayers() {
            console.log('Setting up map layers...');
            
            // Add sources for crashes and ACE data
            console.log('Adding crash and ACE sources...');
            map.addSource('crashes', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });
            
            map.addSource('ace-cameras', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });
            
            // Add transit sources
            console.log('Adding transit sources...');
            map.addSource('bus-routes', {
                type: 'geojson',
                data: transitData.bus_routes
            });
            
            // Deduplicate bus stops at the same location
            console.log('Deduplicating bus stops...');
            const deduplicatedBusStops = deduplicateBusStops(transitData.bus_stops);
            console.log('Bus stops deduplicated successfully');
            
            map.addSource('bus-stops', {
                type: 'geojson',
                data: deduplicatedBusStops
            });
            console.log('Bus stops source added');
            
            // Add NYC congestion zone source with actual zone boundaries
            map.addSource('congestion-zone', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: [
                        {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [[[-73.9592177, 40.7586545], [-73.962899, 40.76024], [-73.9627109, 40.760574], [-73.9627582, 40.7606411], [-73.9628166, 40.7607121], [-73.9628738, 40.7608792], [-73.9629361, 40.76094], [-73.9676372, 40.7630327], [-73.9724084, 40.765044], [-73.9733357, 40.7654104], [-73.9737672, 40.7649272], [-73.9808602, 40.7679278], [-73.980963, 40.7686397], [-73.9924605, 40.7733774], [-73.9932823, 40.7722103], [-73.9938511, 40.7713617], [-73.9941206, 40.769898], [-73.9954558, 40.7678198], [-73.9966746, 40.7659769], [-73.9981835, 40.7639838], [-73.9991778, 40.763033], [-74.0007645, 40.7616972], [-74.0018318, 40.7605226], [-74.0027558, 40.7591771], [-74.0037781, 40.7576249], [-74.0046729, 40.7563681], [-74.0059159, 40.7548219], [-74.0066243, 40.7537403], [-74.0074232, 40.75159], [-74.0077323, 40.750352], [-74.0072282, 40.7487739], [-74.007489, 40.7462796], [-74.0078666, 40.7443744], [-74.0082923, 40.7422208], [-74.008537, 40.7407296], [-74.0093292, 40.7391995], [-74.0093558, 40.7375952], [-74.0098554, 40.7325933], [-74.0100089, 40.7310901], [-74.0100665, 40.7298182], [-74.01033, 40.7275663], [-74.0107424, 40.725111], [-74.0112211, 40.7223279], [-74.0119076, 40.7186505], [-74.0128193, 40.7149813], [-74.0134758, 40.7130675], [-74.0139728, 40.7111899], [-74.014148, 40.7102593], [-74.0143983, 40.7093939], [-74.0149532, 40.7077046], [-74.0145764, 40.7072464], [-74.0143834, 40.7069803], [-74.0142825, 40.7065119], [-74.01447, 40.706057], [-74.014624, 40.705705], [-74.014794, 40.705301], [-74.0149415, 40.7046603], [-74.014407, 40.704454], [-74.01462, 40.703356], [-74.014494, 40.70283], [-74.013971, 40.702303], [-74.0132, 40.7022574], [-74.0129592, 40.7022462], [-74.01286, 40.701722], [-74.0125562, 40.7015574], [-74.0111477, 40.7018365], [-74.0096568, 40.702318], [-74.008178, 40.7032417], [-74.0064798, 40.7043884], [-74.0034072, 40.70636], [-74.0004726, 40.7080542], [-74.0008051, 40.7086504], [-74.001746, 40.7094405], [-74.0027828, 40.7102375], [-74.0033248, 40.7106612], [-74.0035821, 40.7107851], [-74.004088, 40.7108907], [-74.0043095, 40.7109527], [-74.00447, 40.7110589], [-74.0045186, 40.7112163], [-74.0045185, 40.711325], [-74.00446, 40.711419], [-74.004361, 40.711504], [-74.004105, 40.711576], [-74.003562, 40.7115648], [-74.003413, 40.711748], [-74.003238, 40.711899], [-74.002995, 40.711932], [-74.00284, 40.711914], [-74.002667, 40.711825], [-74.002345, 40.711284], [-74.001872, 40.710758], [-74.001281, 40.710215], [-74.0008344, 40.7097934], [-74.0003579, 40.7094133], [-74.000025, 40.7091151], [-73.9998366, 40.7090121], [-73.9994029, 40.7086882], [-73.9990686, 40.7086934], [-73.9987284, 40.7088711], [-73.9980176, 40.7091881], [-73.9965684, 40.7094158], [-73.9948602, 40.7096797], [-73.993555, 40.7098639], [-73.9905637, 40.7102949], [-73.9888049, 40.7105039], [-73.9870935, 40.7107136], [-73.98473, 40.7109303], [-73.9835571, 40.711014], [-73.9818336, 40.7111312], [-73.9795704, 40.7115565], [-73.9786637, 40.7119992], [-73.9780908, 40.7129085], [-73.9769708, 40.714981], [-73.9760738, 40.7167453], [-73.9757009, 40.717774], [-73.9754617, 40.7189241], [-73.97503, 40.7216137], [-73.9748494, 40.7223692], [-73.974478, 40.7230132], [-73.9737245, 40.7242354], [-73.972791, 40.7255485], [-73.9721949, 40.7270026], [-73.9720612, 40.7280148], [-73.9725413, 40.7295884], [-73.9736504, 40.7304466], [-73.9740008, 40.7309898], [-73.9742118, 40.731718], [-73.9743588, 40.7322374], [-73.974632, 40.7333402], [-73.975198, 40.7355147], [-73.97527, 40.73568], [-73.9753818, 40.7363415], [-73.9751363, 40.7371913], [-73.9743511, 40.738195], [-73.9736623, 40.7391983], [-73.9729701, 40.7424296], [-73.9725173, 40.7432435], [-73.9723624, 40.7434175], [-73.9716105, 40.7447917], [-73.9711545, 40.7453843], [-73.9706289, 40.7459687], [-73.9698745, 40.7467523], [-73.9689683, 40.7476975], [-73.9672742, 40.7499694], [-73.9653882, 40.7519325], [-73.964696, 40.7526127], [-73.9632631, 40.7541473], [-73.9628254, 40.7547841], [-73.9616843, 40.755916], [-73.9611687, 40.7565287], [-73.9592177, 40.7586545]]]
                            },
                            properties: {
                                name: 'NYC Congestion Pricing Zone - Main',
                                description: 'Manhattan Central Business District'
                            }
                        },
                        {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [[[-73.9586025, 40.7591455], [-73.9625877, 40.7609042], [-73.9626005, 40.7608501], [-73.9625718, 40.7607887], [-73.9625315, 40.7607222], [-73.9624487, 40.7606173], [-73.962315, 40.7605346], [-73.9621527, 40.760457], [-73.962054, 40.760424], [-73.9616516, 40.7602641], [-73.9609789, 40.7599537], [-73.9602754, 40.7596698], [-73.958705, 40.7589866], [-73.9586025, 40.7591455]]]
                            },
                            properties: {
                                name: 'NYC Congestion Pricing Zone - Section 2',
                                description: 'Additional zone area'
                            }
                        }
                    ]
                }
            });

            // ACE enforcement - Heat zones (bottom layer)
            map.addLayer({
                id: 'ace-heatmap',
                type: 'heatmap',
                source: 'ace-cameras',
                paint: {
                    'heatmap-weight': [
                        'interpolate',
                        ['linear'],
                        ['get', 'tickets_issued'],
                        3, 0.5,
                        15, 1,
                        50, 2,
                        100, 3
                    ],
                    'heatmap-intensity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        8, 0.6,
                        12, 1.0,
                        15, 1.5
                    ],
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0, 'rgba(0,0,0,0)',
                        0.2, 'rgba(138,43,226,0.3)',
                        0.4, 'rgba(147,0,211,0.5)',
                        0.6, 'rgba(199,21,133,0.6)',
                        0.8, 'rgba(219,112,147,0.7)',
                        1, 'rgba(255,20,147,0.8)'
                    ],
                    'heatmap-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        8, 8,
                        12, 12,
                        15, 16
                    ],
                    'heatmap-opacity': 0.65
                }
            });
            
            // NYC Congestion Zone layer (between heatmaps and routes)
            map.addLayer({
                id: 'congestion-zone',
                type: 'fill',
                source: 'congestion-zone',
                paint: {
                    'fill-color': '#FFD700', // Gold/yellow color
                    'fill-opacity': 0.2
                }
            });
            
            // Congestion zone border
            map.addLayer({
                id: 'congestion-zone-border',
                type: 'line',
                source: 'congestion-zone',
                paint: {
                    'line-color': '#FFD700',
                    'line-width': 2,
                    'line-opacity': 0.8
                }
            });
            
            // Bus routes layer (background layer)
            map.addLayer({
                id: 'bus-routes',
                type: 'line',
                source: 'bus-routes',
                paint: {
                    'line-color': [
                        'case',
                        ['has', 'route_color'], ['get', 'route_color'],
                        '#00A8E8' // Default blue
                    ],
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        8, 0.8,
                        12, 2,
                        16, 4
                    ],
                    'line-opacity': 0.6
                }
            });
            
            // Bus stops layer
            map.addLayer({
                id: 'bus-stops',
                type: 'circle',
                source: 'bus-stops',
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        8, 1,
                        12, 2,
                        16, 4
                    ],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#2E86AB',
                    'circle-opacity': 0.8
                }
            });
            
            // Bus route labels
            map.addLayer({
                id: 'bus-route-labels',
                type: 'symbol',
                source: 'bus-routes',
                minzoom: 12,
                layout: {
                    'text-field': [
                        'case',
                        ['has', 'route_name'], ['get', 'route_name'],
                        ['has', 'route_short_name'], ['get', 'route_short_name'],
                        ['get', 'route_id']
                    ],
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        12, 10,
                        16, 14
                    ],
                    'symbol-placement': 'line',
                    'text-rotation-alignment': 'map',
                    'text-pitch-alignment': 'viewport'
                },
                'paint': {
                    'text-color': '#ffffff',
                    'text-halo-color': '#000000',
                    'text-halo-width': 2,
                    'text-opacity': 0.9
                }
            });

            // Crash heatmap layer (top layer - more prominent)
            map.addLayer({
                id: 'crashes-heatmap',
                type: 'heatmap',
                source: 'crashes',
                paint: {
                    'heatmap-weight': [
                        'case',
                        ['>', ['get', 'killed'], 0], 3,
                        ['>', ['get', 'injured'], 0], 2,
                        1
                    ],
                    'heatmap-intensity': 2.0,
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0, 'rgba(0,0,0,0)',
                        0.2, 'rgba(65,105,225,0.7)',
                        0.4, 'rgba(0,191,255,0.8)',
                        0.6, 'rgba(255,215,0,0.9)',
                        0.8, 'rgba(255,140,0,0.95)',
                        1, 'rgba(220,20,60,1.0)'
                    ],
                    'heatmap-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        8, 2,
                        12, 4,
                        14, 6,
                        16, 10
                    ],
                    'heatmap-opacity': 0.75
                }
            });
            
            // Set initial layer visibility based on default toggle states
            setInitialLayerVisibility();

            // Click handlers for interactive analysis
            
            // Bus route clicks - just do area analysis (no popup)
            // Removed bus route popup, now clicking bus routes just does area analysis
            
            // Bus stop clicks - analyze area around stop
            map.on('click', 'bus-stops', function(e) {
                e.originalEvent.stopPropagation();
                const properties = e.features[0].properties;
                const routes = JSON.parse(properties.routes_served || '[]');
                
                analyzeArea(e.lngLat, `Bus Stop: ${properties.stop_name}`, {
                    stop_id: properties.stop_id,
                    routes_served: routes.slice(0, 5).join(', ') + (routes.length > 5 ? '...' : '')
                });
            });
            
            
            // Click anywhere on map for area analysis
            map.on('click', function(e) {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['bus-stops']
                });
                
                if (features.length === 0) {
                    analyzeArea(e.lngLat, 'Area Analysis');
                }
            });
            
            map.on('mouseenter', 'bus-routes', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'bus-routes', () => {
                map.getCanvas().style.cursor = '';
            });
            
            map.on('mouseenter', 'bus-stops', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'bus-stops', () => {
                map.getCanvas().style.cursor = '';
            });
        }
        
        function setInitialLayerVisibility() {
            // Set layer visibility based on initial toggle states
            map.setLayoutProperty('crashes-heatmap', 'visibility', showCrashes ? 'visible' : 'none');
            map.setLayoutProperty('ace-heatmap', 'visibility', showACE ? 'visible' : 'none');
            map.setLayoutProperty('bus-routes', 'visibility', showTransit ? 'visible' : 'none');
            map.setLayoutProperty('bus-route-labels', 'visibility', showTransit ? 'visible' : 'none');
            map.setLayoutProperty('bus-stops', 'visibility', showStops ? 'visible' : 'none');
            map.setLayoutProperty('congestion-zone', 'visibility', showCongestionZone ? 'visible' : 'none');
            map.setLayoutProperty('congestion-zone-border', 'visibility', showCongestionZone ? 'visible' : 'none');
            
            console.log('Initial layer visibility set:', {
                crashes: showCrashes,
                ace: showACE,
                transit: showTransit,
                stops: showStops,
                congestion: showCongestionZone
            });
        }

        function getMonthIndexFromSliderValue(sliderValue) {
            // Simplified month detection to prevent glitching at high speeds
            const monthCount = combinedData.crash_data.unique_months.length;
            const stepsPerMonth = 1000;
            
            // Use simple rounding for smoother behavior at high speeds
            const rawMonthIndex = sliderValue / stepsPerMonth;
            let monthIndex = Math.floor(rawMonthIndex + 0.3); // Slight bias toward staying in current month
            
            // Ensure we stay within bounds
            monthIndex = Math.max(0, Math.min(monthCount - 1, monthIndex));
            
            return monthIndex;
        }
        
        function setupUI() {
            // Setup slider with high resolution for smooth animation
            const slider = document.getElementById('time-slider');
            if (slider) {
                const monthCount = combinedData.crash_data.unique_months.length;
                // Use 1000 steps per month for ultra-smooth animation
                slider.max = (monthCount - 1) * 1000;
                slider.step = 1;
                
                // Track user interaction with slider
                slider.addEventListener('mousedown', () => {
                    userInteracting = true;
                });
                
                slider.addEventListener('touchstart', () => {
                    userInteracting = true;
                });
                
                slider.addEventListener('mouseup', () => {
                    setTimeout(() => { userInteracting = false; }, 100); // Small delay to ensure smooth transition
                });
                
                slider.addEventListener('touchend', () => {
                    setTimeout(() => { userInteracting = false; }, 100);
                });
                
                slider.addEventListener('input', (e) => {
                    // Convert high-res slider value back to month index with smooth ranges
                    const sliderValue = parseFloat(e.target.value);
                    currentMonthIndex = getMonthIndexFromSliderValue(sliderValue);
                    updateVisualization(false); // Don't smooth when user drags slider
                });
            }
            
            // Setup date labels
            updateSliderDateLabels();
        }
        
        function formatDateToMMYYYY(dateStr) {
            // Convert "2022-01" to "2022:01"
            const [year, month] = dateStr.split('-');
            return `${year}:${month}`;
        }
        
        function updateSliderDateLabels() {
            if (!combinedData || !combinedData.crash_data.unique_months) return;
            
            const months = combinedData.crash_data.unique_months;
            const endDate = formatDateToMMYYYY(months[months.length - 1]);
            
            // Right label shows end date, left label will be updated in updateVisualization
            document.getElementById('slider-end-date').textContent = endDate;
        }

        function smoothUpdateSlider(targetMonthIndex) {
            const slider = document.getElementById('time-slider');
            const startValue = parseFloat(slider.value);
            // Convert month index to high-res slider value (1000 steps per month)
            const targetValue = targetMonthIndex * 1000;
            
            console.log(`Smooth slider update: ${startValue} → ${targetValue} (month ${targetMonthIndex})`);
            
            // Simple smooth animation using requestAnimationFrame
            const duration = Math.max(200, 500 / playbackSpeed);
            const startTime = performance.now();
            
            // Cancel any existing animation
            if (sliderAnimationId) {
                cancelAnimationFrame(sliderAnimationId);
            }
            
            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Use ease-out for natural feeling
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentValue = startValue + (targetValue - startValue) * easeOut;
                
                slider.value = currentValue;
                
                if (progress < 1) {
                    sliderAnimationId = requestAnimationFrame(animate);
                } else {
                    slider.value = targetValue;
                    sliderAnimationId = null;
                }
            };
            
            sliderAnimationId = requestAnimationFrame(animate);
        }
        
        function updateVisualization(smoothSlider = true) {
            if (!combinedData || !map || !map.getSource('crashes') || !map.getSource('ace-cameras')) {
                console.log('Waiting for map and data to be ready...');
                return;
            }
            
            const currentMonth = combinedData.crash_data.unique_months[currentMonthIndex];
            const currentCrashData = combinedData.crash_data.monthly_data[currentMonth];
            const currentACEData = combinedData.ace_data.monthly_data[currentMonth] || {type: 'FeatureCollection', features: []};
            const currentLabel = combinedData.crash_data.month_labels[currentMonthIndex];

            // Update map data
            map.getSource('crashes').setData(currentCrashData);
            map.getSource('ace-cameras').setData(currentACEData);

            // Calculate total tickets issued this month
            const totalTicketsThisMonth = currentACEData.features.reduce((sum, feature) => sum + (feature.properties.tickets_issued || 0), 0);
            
            // Update UI
            document.getElementById('month-display').textContent = currentLabel;
            document.getElementById('crash-count').textContent = `${currentCrashData.features.length.toLocaleString()} crashes`;
            document.getElementById('ace-count').textContent = `${totalTicketsThisMonth.toLocaleString()} tickets issued`;
            
            // Update slider smoothly or instantly
            if (smoothSlider && isPlaying) {
                console.log(`Using smooth slider update (isPlaying: ${isPlaying}, speed: ${playbackSpeed}x)`);
                smoothUpdateSlider(currentMonthIndex);
            } else {
                console.log(`Using instant slider update (smoothSlider: ${smoothSlider}, isPlaying: ${isPlaying})`);
                document.getElementById('time-slider').value = currentMonthIndex * 1000;
            }
            
            // Update left date label with current selected date
            const currentDateFormatted = formatDateToMMYYYY(currentMonth);
            document.getElementById('slider-start-date').textContent = currentDateFormatted;
            
            console.log(`Updated to ${currentLabel}: ${currentCrashData.features.length} crashes, ${totalTicketsThisMonth} ACE tickets`);
        }

        function toggleCrashes() {
            showCrashes = !showCrashes;
            
            // Animate the visibility change
            animateLayerVisibility('crashes-heatmap', showCrashes);
            
            document.getElementById('crashes-toggle').classList.toggle('active', showCrashes);
        }

        function toggleACE() {
            showACE = !showACE;
            const visibility = showACE ? 'visible' : 'none';
            
            map.setLayoutProperty('ace-heatmap', 'visibility', visibility);
            
            document.getElementById('ace-toggle').classList.toggle('active', showACE);
        }
        
        function toggleTransit() {
            showTransit = !showTransit;
            
            // Use updateRouteColoring to respect current route mode filtering
            updateRouteColoring();
            
            document.getElementById('transit-toggle').classList.toggle('active', showTransit);
        }
        
        function toggleStops() {
            showStops = !showStops;
            const visibility = showStops ? 'visible' : 'none';
            
            map.setLayoutProperty('bus-stops', 'visibility', visibility);
            
            document.getElementById('stops-toggle').classList.toggle('active', showStops);
        }
        
        function toggleCongestionZone() {
            showCongestionZone = !showCongestionZone;
            const visibility = showCongestionZone ? 'visible' : 'none';
            
            map.setLayoutProperty('congestion-zone', 'visibility', visibility);
            map.setLayoutProperty('congestion-zone-border', 'visibility', visibility);
            
            document.getElementById('congestion-toggle').classList.toggle('active', showCongestionZone);
        }
        
        function cycleRouteMode() {
            routeMode = (routeMode + 1) % 3;
            updateRouteMode();
        }
        
        function updateRouteMode() {
            const slider = document.getElementById('route-mode-slider');
            
            // Update slider visual state
            slider.className = `route-mode-container mode-${routeMode}`;
            
            // Update route coloring and visibility based on mode
            updateRouteColoring();
        }
        
        function updateRouteColoring() {
            if (!map.getLayer('bus-routes')) return;
            
            // List of known ACE-enabled routes (common NYC ACE routes)
            const aceRoutes = [
                'M14A', 'M14D', 'M23', 'M34A', 'M42', 'M57', 'M79', 'M86', 'M96', 'M103', 'M116', 'M125',
                'B44', 'B46', 'B35', 'B15', 'B25', 'B26', 'B41', 'B63', 'B67', 'B68',
                'BX19', 'BX35', 'BX41', 'BX6', 'BX15', 'BX36', 'BX46',
                'Q44', 'Q58', 'Q32', 'Q53', 'Q101', 'Q102', 'Q103'
            ];
            
            if (routeMode === 0) {
                // Mode 0: Bus Routes - Each route has its own color
                // Remove any filters first
                map.setFilter('bus-routes', null);
                map.setFilter('bus-route-labels', null);
                
                map.setPaintProperty('bus-routes', 'line-color', [
                    'case',
                    ['has', 'route_color'], ['get', 'route_color'],
                    '#00A8E8' // Default blue
                ]);
                
                // Show all routes and labels
                map.setLayoutProperty('bus-routes', 'visibility', showTransit ? 'visible' : 'none');
                map.setLayoutProperty('bus-route-labels', 'visibility', showTransit ? 'visible' : 'none');
            } else if (routeMode === 1) {
                // Mode 1: ACE Mode - ACE routes red, others blue
                // Remove any filters first
                map.setFilter('bus-routes', null);
                map.setFilter('bus-route-labels', null);
                
                map.setPaintProperty('bus-routes', 'line-color', [
                    'case',
                    ['in', ['get', 'route_name'], ['literal', aceRoutes]], 
                    '#FF6B6B', // Red for ACE routes
                    '#0066CC'  // Blue for non-ACE routes
                ]);
                
                // Show all routes and labels
                map.setLayoutProperty('bus-routes', 'visibility', showTransit ? 'visible' : 'none');
                map.setLayoutProperty('bus-route-labels', 'visibility', showTransit ? 'visible' : 'none');
            } else if (routeMode === 2) {
                // Mode 2: ACE Only - Show only ACE routes in red
                map.setPaintProperty('bus-routes', 'line-color', '#FF6B6B');
                
                // Filter to show only ACE routes
                map.setFilter('bus-routes', ['in', ['get', 'route_name'], ['literal', aceRoutes]]);
                map.setFilter('bus-route-labels', ['in', ['get', 'route_name'], ['literal', aceRoutes]]);
                
                // Show filtered routes and labels
                map.setLayoutProperty('bus-routes', 'visibility', showTransit ? 'visible' : 'none');
                map.setLayoutProperty('bus-route-labels', 'visibility', showTransit ? 'visible' : 'none');
            }
            
            console.log(`Route mode updated to: ${routeMode} (${['Bus Routes', 'ACE Mode', 'ACE Only'][routeMode]})`);
        }
        
        // Fade animation system for layer visibility changes
        function animateLayerVisibility(layerName, show, duration = 300) {
            if (!map.getLayer(layerName)) return Promise.resolve();
            
            return new Promise((resolve) => {
                const startTime = performance.now();
                let originalOpacity = null;
                
                // Get the current opacity property name based on layer type
                const getOpacityProperty = (layer) => {
                    const layerType = map.getLayer(layer).type;
                    switch (layerType) {
                        case 'heatmap': return 'heatmap-opacity';
                        case 'line': return 'line-opacity';
                        case 'circle': return 'circle-opacity';
                        case 'fill': return 'fill-opacity';
                        case 'symbol': return 'text-opacity';
                        default: return 'opacity';
                    }
                };
                
                const opacityProperty = getOpacityProperty(layerName);
                
                // Get original opacity values
                const originalOpacities = {
                    'crashes-heatmap': 0.75,
                    'ace-heatmap': 0.65,
                    'bus-routes': 0.6,
                    'bus-stops': 0.8,
                    'congestion-zone': 0.2,
                    'congestion-zone-border': 0.8,
                    'bus-route-labels': 0.9
                };
                
                originalOpacity = originalOpacities[layerName] || 1.0;
                const targetOpacity = show ? originalOpacity * globalOpacity : 0;
                
                // Ensure layer is visible during fade
                map.setLayoutProperty(layerName, 'visibility', 'visible');
                
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Use ease-in-out for smooth transitions
                    const easeInOut = progress < 0.5 
                        ? 2 * progress * progress 
                        : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                    
                    const currentOpacity = show 
                        ? easeInOut * targetOpacity
                        : originalOpacity * globalOpacity * (1 - easeInOut);
                    
                    try {
                        map.setPaintProperty(layerName, opacityProperty, currentOpacity);
                    } catch (error) {
                        console.warn(`Could not set ${opacityProperty} for ${layerName}:`, error);
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // Final state
                        if (!show) {
                            map.setLayoutProperty(layerName, 'visibility', 'none');
                        }
                        resolve();
                    }
                };
                
                requestAnimationFrame(animate);
            });
        }
        
        // Animate multiple layers simultaneously
        function animateMultipleLayers(layerChanges, duration = 300) {
            const promises = layerChanges.map(({ layer, show }) => 
                animateLayerVisibility(layer, show, duration)
            );
            return Promise.all(promises);
        }
        
        function updateOpacity(value) {
            // Convert percentage to decimal (10-100 -> 0.1-1.0)
            globalOpacity = value / 100;
            
            // Update opacity display
            document.getElementById('opacity-value').textContent = value + '%';
            
            // Define original opacity values for proper scaling
            const layersToUpdate = [
                { layer: 'crashes-heatmap', property: 'heatmap-opacity', originalOpacity: 0.75 },
                { layer: 'ace-heatmap', property: 'heatmap-opacity', originalOpacity: 0.65 },
                { layer: 'bus-routes', property: 'line-opacity', originalOpacity: 0.6 },
                { layer: 'bus-stops', property: 'circle-opacity', originalOpacity: 0.8 },
                { layer: 'bus-stops', property: 'circle-stroke-opacity', originalOpacity: 1.0 },
                { layer: 'congestion-zone', property: 'fill-opacity', originalOpacity: 0.2 },
                { layer: 'congestion-zone-border', property: 'line-opacity', originalOpacity: 0.8 },
                { layer: 'bus-route-labels', property: 'text-opacity', originalOpacity: 0.9 },
                { layer: 'bus-route-labels', property: 'text-halo-opacity', originalOpacity: 1.0 }
            ];
            
            layersToUpdate.forEach(({ layer, property, originalOpacity }) => {
                if (map.getLayer(layer)) {
                    // Scale the original opacity by the global opacity multiplier
                    const newOpacity = originalOpacity * globalOpacity;
                    map.setPaintProperty(layer, property, newOpacity);
                }
            });
            
            console.log(`Updated global opacity to ${(globalOpacity * 100).toFixed(0)}%`);
        }
        
        // Story navigation functionality
        let currentSectionIndex = 0;
        let sections = [];
        let isScrolling = false;
        
        function initStoryNavigation() {
            sections = document.querySelectorAll('.chart-section');
            const storyDisplay = document.getElementById('story-display');
            
            // Create progress dots
            createProgressDots();
            
            // Add scroll snap behavior
            storyDisplay.addEventListener('scroll', function() {
                if (!isScrolling) {
                    updateActiveSection();
                }
            });
            
            // Removed wheel event handler - rely on natural scroll behavior
        }
        
        function createProgressDots() {
            const progressContainer = document.getElementById('progress-dots');
            progressContainer.innerHTML = '';
            
            sections.forEach((section, index) => {
                const dot = document.createElement('div');
                dot.className = `progress-dot ${index === 0 ? 'active' : ''}`;
                dot.addEventListener('click', () => showSection(index));
                progressContainer.appendChild(dot);
            });
        }
        
        function updateActiveSection() {
            const storyDisplay = document.getElementById('story-display');
            const scrollTop = storyDisplay.scrollTop;
            const sectionHeight = storyDisplay.clientHeight;
            const newIndex = Math.round(scrollTop / sectionHeight);
            
            if (newIndex !== currentSectionIndex && newIndex >= 0 && newIndex < sections.length) {
                setActiveSection(newIndex);
            }
        }
        
        function showSection(index) {
            if (index < 0 || index >= sections.length) return;
            
            isScrolling = true;
            const storyDisplay = document.getElementById('story-display');
            const targetScroll = index * storyDisplay.clientHeight;
            
            storyDisplay.scrollTo({
                top: targetScroll,
                behavior: 'smooth'
            });
            
            setTimeout(() => {
                isScrolling = false;
                setActiveSection(index);
            }, 500);
        }
        
        function setActiveSection(index) {
            console.log(`setActiveSection called with index: ${index}`);
            
            // Remove active class from all sections
            sections.forEach(section => section.classList.remove('active'));
            
            // Add active class to current section
            sections[index].classList.add('active');
            
            // Update progress dots
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            // Update counter
            document.getElementById('section-counter').textContent = `${index + 1} / ${sections.length}`;
            
            // Store the previous section before updating (but don't update currentSectionIndex yet)
            const previousSectionIndex = currentSectionIndex;
            
            // Hierarchical slide setup - specific slides override general rules
            
            // Handle data display based on slide ranges (avoid conflicts)
            if (index >= 0 && index <= 1) {
                // Slides 1-2: No crashes, no tickets
                console.log(`Slide ${index + 1}: No crashes, no tickets`);
                
                // Turn off crashes if they're on
                if (showCrashes) {
                    const crashesToggle = document.getElementById('crashes-toggle');
                    if (crashesToggle) {
                        crashesToggle.click();
                    }
                }
                
                // Turn off tickets if they're on
                if (showACE) {
                    const aceToggle = document.getElementById('ace-toggle');
                    if (aceToggle) {
                        aceToggle.click();
                    }
                }
            } else if (index >= 2 && index <= 15) {
                // Slides 3-16: Tickets on, crashes off
                console.log(`Slide ${index + 1}: Tickets on, crashes off`);
                
                // Turn on tickets if they're off
                if (!showACE) {
                    const aceToggle = document.getElementById('ace-toggle');
                    if (aceToggle) {
                        aceToggle.click();
                    }
                }
                
                // Turn off crashes if they're on
                if (showCrashes) {
                    const crashesToggle = document.getElementById('crashes-toggle');
                    if (crashesToggle) {
                        crashesToggle.click();
                    }
                }
            } else if (index >= 16 && index <= 17) {
                // Slides 17-18: Crashes on, tickets off (keep animation running)
                console.log(`Slide ${index + 1}: Crashes on, tickets off`);
                console.log(`Current state before changes - Crashes: ${showCrashes}, Tickets: ${showACE}`);
                
                // Turn off tickets if they're on
                if (showACE) {
                    console.log('Turning off tickets...');
                    const aceToggle = document.getElementById('ace-toggle');
                    if (aceToggle) {
                        aceToggle.click();
                    }
                }
                
                // Turn on crashes if they're off (with a small delay to avoid conflicts)
                if (!showCrashes) {
                    console.log('Turning on crashes...');
                    setTimeout(() => {
                        const crashesToggle = document.getElementById('crashes-toggle');
                        if (crashesToggle && !showCrashes) { // Double-check before toggling
                            crashesToggle.click();
                        }
                    }, 50); // Small delay to ensure tickets are fully turned off first
                } else {
                    console.log('Crashes already on, no need to toggle');
                }
                
                console.log(`State after changes - Crashes: ${showCrashes}, Tickets: ${showACE}`);
            }
            
            // Slide 1 specific setup
            if (index === 0) {
                console.log('Slide 1: Resetting to default state');
                
                // Reset route mode to default (Bus Routes - mode 0)
                if (routeMode !== 0) {
                    const routeModeSlider = document.getElementById('route-mode-slider');
                    if (routeModeSlider) {
                        // Click until we reach mode 0 (Bus Routes)
                        while (routeMode !== 0) {
                            routeModeSlider.click();
                        }
                    }
                }
                
                // Turn on congestion zone if it's off (default is on)
                if (!showCongestionZone) {
                    const congestionToggle = document.getElementById('congestion-toggle');
                    if (congestionToggle) {
                        congestionToggle.click();
                    }
                }
            }
            
            // Special handling for slides 2-12 (index 1-11) - ACE mode on
            if (index >= 1 && index <= 11) {
                console.log(`Slide ${index + 1}: Setting ACE mode on`);
                
                // Set route mode to ACE mode (mode 1)
                if (routeMode !== 1) {
                    const routeModeSlider = document.getElementById('route-mode-slider');
                    if (routeModeSlider) {
                        // Click until we reach mode 1 (ACE mode)
                        while (routeMode !== 1) {
                            routeModeSlider.click();
                        }
                    }
                }
                
                // Slide 2 specific setup - turn off congestion zone
                if (index === 1 && previousSectionIndex !== 2) {
                    console.log('Slide 2: Also turning off congestion zone (not coming from slide 3)');
                    
                    // Turn off congestion zone if it's on
                    if (showCongestionZone) {
                        const congestionToggle = document.getElementById('congestion-toggle');
                        if (congestionToggle) {
                            congestionToggle.click();
                        }
                    }
                }
            }
            
            // Special handling for slide 3 (index 2) - Congestion on, tickets on, reduced route opacity
            if (index === 2) {
                console.log('Slide 3: Setting congestion on, tickets on, and reducing route opacity');
                
                // Turn on congestion zone if it's off
                if (!showCongestionZone) {
                    const congestionToggle = document.getElementById('congestion-toggle');
                    if (congestionToggle) {
                        congestionToggle.click();
                    }
                }
                
                // Turn on tickets (ACE data) if it's off
                if (!showACE) {
                    const aceToggle = document.getElementById('ace-toggle');
                    if (aceToggle) {
                        aceToggle.click();
                    }
                }
                
                // Reduce route opacity to make congestion zone and tickets more prominent
                if (map.getLayer('bus-routes')) {
                    map.setPaintProperty('bus-routes', 'line-opacity', 0.2);
                }
                if (map.getLayer('bus-route-labels')) {
                    map.setPaintProperty('bus-route-labels', 'text-opacity', 0.3);
                    map.setPaintProperty('bus-route-labels', 'text-halo-opacity', 0.3);
                }
            }
            
            // Special handling for slide 3 specifically - Always set up loop animation
            if (index === 2) {
                console.log('Slide 3: Setting up loop animation explicitly (with delay)');
                
                // Add a small delay to let other slide 3 setup complete first
                setTimeout(() => {
                    console.log('Slide 3: Starting delayed animation setup');
                    
                    // Force stop any current animation first
                    if (isPlaying) {
                        console.log('Stopping current animation before setup');
                        stopAnimation();
                    }
                    
                    // Store current speed before changing to 4x
                    if (playbackSpeed !== 4) {
                        previousPlaybackSpeed = playbackSpeed;
                        console.log(`Storing previous speed: ${previousPlaybackSpeed}x, setting to 4x...`);
                        
                        // Set speed directly to 4x
                        playbackSpeed = 4;
                        const speedButton = document.getElementById('speed-button');
                        if (speedButton) {
                            speedButton.textContent = '4x';
                            speedButton.title = 'Playback Speed: 4x';
                        }
                        console.log('Set playback speed directly to 4x');
                    }
                    
                    // Enable loop directly
                    console.log(`Current loop state: ${isLoopEnabled}, enabling loop...`);
                    if (!isLoopEnabled) {
                        toggleLoop();
                        console.log(`Loop enabled via toggleLoop(), new state: ${isLoopEnabled}`);
                    } else {
                        console.log('Loop already enabled');
                    }
                    
                    // Start playback directly
                    console.log(`Current playing state: ${isPlaying}, starting playback...`);
                    if (!isPlaying) {
                        startAnimation();
                        console.log(`Animation started via startAnimation(), new state: ${isPlaying}`);
                    } else {
                        console.log('Animation already playing');
                    }
                    
                    // Double-check final states
                    setTimeout(() => {
                        console.log(`Final check - Loop: ${isLoopEnabled}, Playing: ${isPlaying}, Speed: ${playbackSpeed}x`);
                        if (!isPlaying) {
                            console.log('ERROR: Animation still not playing after setup!');
                        }
                        if (!isLoopEnabled) {
                            console.log('ERROR: Loop still not enabled after setup!');
                        }
                    }, 50);
                    
                    console.log('Started 4x speed looped timeline animation for slide 3');
                    autoAnimationActive = true;
                }, 100); // 100ms delay to let other changes settle
            }
            
            
            // Special handling for slides 4-17 (index 3-16) - Keep animation running
            if (index >= 3 && index <= 16) {
                console.log(`On slide ${index + 1} - Animation should be running (slides 4-17)`);
                
                // Ensure animation is still running (don't restart if already running)
                if (!isPlaying) {
                    console.log('Animation stopped, restarting...');
                    startAnimation();
                }
                if (!isLoopEnabled) {
                    console.log('Loop disabled, re-enabling...');
                    toggleLoop();
                }
                if (playbackSpeed !== 4) {
                    console.log('Speed not 4x, fixing and restarting animation...');
                    playbackSpeed = 4;
                    const speedButton = document.getElementById('speed-button');
                    if (speedButton) {
                        speedButton.textContent = '4x';
                        speedButton.title = 'Playback Speed: 4x';
                    }
                    // Restart animation to pick up new speed
                    if (isPlaying) {
                        stopAnimation();
                        startAnimation();
                    }
                }
                
                autoAnimationActive = true;
            } else {
                // Slides 1-2 and 18+: Reset to normal behavior
                resetMapOpacity();
            }
            
            // Reset route opacity when leaving slide 3
            if (previousSectionIndex === 2 && index !== 2) {
                console.log('Leaving slide 3: Resetting route opacity');
                resetMapOpacity();
                
                // Special handling when going from slide 3 to slide 2
                if (index === 1) {
                    console.log('Going from slide 3 to slide 2: Setting up slide 2 configuration');
                    
                    // Set route mode to ACE mode (mode 1)
                    if (routeMode !== 1) {
                        const routeModeSlider = document.getElementById('route-mode-slider');
                        if (routeModeSlider) {
                            // Click until we reach mode 1 (ACE mode)
                            while (routeMode !== 1) {
                                routeModeSlider.click();
                            }
                        }
                    }
                    
                    // Turn off congestion zone if it's on
                    if (showCongestionZone) {
                        const congestionToggle = document.getElementById('congestion-toggle');
                        if (congestionToggle) {
                            congestionToggle.click();
                        }
                    }
                }
            }
            
            // Stop auto-animation when leaving the entire 3-12 range (slides 3-12)
            if (currentSectionIndex >= 2 && currentSectionIndex <= 11 && (index < 2 || index > 11)) {
                console.log('Leaving auto-play section (slides 3-11)');
                
                // Restore previous speed
                if (playbackSpeed === 4 && previousPlaybackSpeed !== 4) {
                    console.log(`Restoring previous speed: ${previousPlaybackSpeed}x`);
                    playbackSpeed = previousPlaybackSpeed;
                    const speedButton = document.getElementById('speed-button');
                    if (speedButton) {
                        speedButton.textContent = `${previousPlaybackSpeed}x`;
                        speedButton.title = `Playback Speed: ${previousPlaybackSpeed}x`;
                    }
                    console.log('Speed restored directly');
                }
                
                // Stop animation
                if (isPlaying) {
                    console.log('Stopping playback...');
                    stopAnimation();
                }
                
                // Disable loop
                if (isLoopEnabled) {
                    console.log('Disabling loop...');
                    toggleLoop();
                }
                
                console.log('Left auto-play section: Restored speed and stopped timeline animation');
                autoAnimationActive = false;
            }
            
            // Update currentSectionIndex at the very end
            currentSectionIndex = index;
        }
        
        function adjustMapForACESection() {
            // Highlight ACE heatmap and keep bus routes, dim everything else
            const layerAdjustments = [
                { layer: 'crashes-heatmap', property: 'heatmap-opacity', opacity: 0.1 }, // Very low opacity
                { layer: 'ace-heatmap', property: 'heatmap-opacity', opacity: 0.8 }, // Prominent ACE
                { layer: 'bus-routes', property: 'line-opacity', opacity: 0.6 }, // Keep bus routes visible
                { layer: 'bus-stops', property: 'circle-opacity', opacity: 0.1 }, // Very low opacity
                { layer: 'bus-stops', property: 'circle-stroke-opacity', opacity: 0.1 }, // Very low opacity
                { layer: 'congestion-zone', property: 'fill-opacity', opacity: 0.05 }, // Very low opacity
                { layer: 'congestion-zone-border', property: 'line-opacity', opacity: 0.1 }, // Very low opacity
                { layer: 'bus-route-labels', property: 'text-opacity', opacity: 0.4 }, // Dim but readable
                { layer: 'bus-route-labels', property: 'text-halo-opacity', opacity: 0.3 } // Dim the text halo/border
            ];
            
            layerAdjustments.forEach(({ layer, property, opacity }) => {
                try {
                    if (map.getLayer(layer)) {
                        map.setPaintProperty(layer, property, opacity);
                    }
                } catch (error) {
                    console.warn(`Could not set ${property} for layer ${layer}:`, error);
                }
            });
            
            console.log('Adjusted map for ACE section: ACE prominent, others dimmed');
        }
        
        function resetMapOpacity() {
            // Reset to original opacity values (scaled by global opacity if set)
            const originalOpacities = [
                { layer: 'crashes-heatmap', property: 'heatmap-opacity', originalOpacity: 0.75 },
                { layer: 'ace-heatmap', property: 'heatmap-opacity', originalOpacity: 0.65 },
                { layer: 'bus-routes', property: 'line-opacity', originalOpacity: 0.6 },
                { layer: 'bus-stops', property: 'circle-opacity', originalOpacity: 0.8 },
                { layer: 'bus-stops', property: 'circle-stroke-opacity', originalOpacity: 1.0 },
                { layer: 'congestion-zone', property: 'fill-opacity', originalOpacity: 0.2 },
                { layer: 'congestion-zone-border', property: 'line-opacity', originalOpacity: 0.8 },
                { layer: 'bus-route-labels', property: 'text-opacity', originalOpacity: 0.9 },
                { layer: 'bus-route-labels', property: 'text-halo-opacity', originalOpacity: 1.0 } // Reset halo/border
            ];
            
            originalOpacities.forEach(({ layer, property, originalOpacity }) => {
                try {
                    if (map.getLayer(layer)) {
                        // Scale by global opacity if it's been changed
                        const scaledOpacity = originalOpacity * globalOpacity;
                        map.setPaintProperty(layer, property, scaledOpacity);
                    }
                } catch (error) {
                    console.warn(`Could not reset ${property} for layer ${layer}:`, error);
                }
            });
            
            console.log('Reset map to normal opacity values');
        }
        
        function showNextSection() {
            const nextIndex = Math.min(currentSectionIndex + 1, sections.length - 1);
            showSection(nextIndex);
        }
        
        function showPreviousSection() {
            const prevIndex = Math.max(currentSectionIndex - 1, 0);
            showSection(prevIndex);
        }
        
        // Direct navigation function for testing
        function goToThirdSection() {
            console.log('Direct navigation to section 3');
            showSection(2); // Index 2 = 3rd section
        }
        
        function showAllData() {
            if (isPlaying) {
                stopAnimation();
            }
            
            // Show all months data
            const allCrashFeatures = [];
            const allAceFeatures = [];
            
            combinedData.crash_data.unique_months.forEach(month => {
                if (combinedData.crash_data.monthly_data[month]) {
                    allCrashFeatures.push(...combinedData.crash_data.monthly_data[month].features);
                }
                if (combinedData.ace_data.monthly_data[month]) {
                    allAceFeatures.push(...combinedData.ace_data.monthly_data[month].features);
                }
            });
            
            // Update map sources
            map.getSource('crashes').setData({
                type: 'FeatureCollection',
                features: allCrashFeatures
            });
            
            map.getSource('ace-cameras').setData({
                type: 'FeatureCollection', 
                features: allAceFeatures
            });
            
            // Calculate total tickets
            const totalTickets = allAceFeatures.reduce((sum, f) => sum + (f.properties.tickets_issued || 0), 0);
            
            // Update UI
            document.getElementById('month-display').textContent = 'All Months';
            document.getElementById('crash-count').textContent = `${allCrashFeatures.length.toLocaleString()} crashes`;
            document.getElementById('ace-count').textContent = `${totalTickets.toLocaleString()} tickets issued`;
            document.getElementById('time-slider').value = (combinedData.crash_data.unique_months.length - 1) * 1000;
            
            currentMonthIndex = combinedData.crash_data.unique_months.length - 1;
        }
        
        function analyzeArea(lngLat, title, additionalInfo = {}) {
            const radius = 150; // 150 meters
            const lat = lngLat.lat;
            const lng = lngLat.lng;
            
            // Get current data based on time slider
            let crashFeatures, aceFeatures;
            
            if (currentMonthIndex >= combinedData.crash_data.unique_months.length - 1 || document.getElementById('month-display').textContent === 'All Months') {
                // Show all data
                crashFeatures = [];
                aceFeatures = [];
                combinedData.crash_data.unique_months.forEach(month => {
                    if (combinedData.crash_data.monthly_data[month]) {
                        crashFeatures.push(...combinedData.crash_data.monthly_data[month].features);
                    }
                    if (combinedData.ace_data.monthly_data[month]) {
                        aceFeatures.push(...combinedData.ace_data.monthly_data[month].features);
                    }
                });
            } else {
                // Show current month data
                const month = combinedData.crash_data.unique_months[currentMonthIndex];
                crashFeatures = combinedData.crash_data.monthly_data[month] ? combinedData.crash_data.monthly_data[month].features : [];
                aceFeatures = combinedData.ace_data.monthly_data[month] ? combinedData.ace_data.monthly_data[month].features : [];
            }
            
            // Find nearby crashes
            const nearbyCrashes = crashFeatures.filter(feature => {
                const crashLng = feature.geometry.coordinates[0];
                const crashLat = feature.geometry.coordinates[1];
                const distance = getDistance(lat, lng, crashLat, crashLng);
                return distance <= radius;
            });
            
            // Find nearby ACE violations
            const nearbyACE = aceFeatures.filter(feature => {
                const aceLng = feature.geometry.coordinates[0];
                const aceLat = feature.geometry.coordinates[1];
                const distance = getDistance(lat, lng, aceLat, aceLng);
                return distance <= radius;
            });
            
            // Calculate statistics
            const totalCrashes = nearbyCrashes.length;
            const totalInjured = nearbyCrashes.reduce((sum, f) => sum + (f.properties.injured || 0), 0);
            const totalKilled = nearbyCrashes.reduce((sum, f) => sum + (f.properties.killed || 0), 0);
            const totalACETickets = nearbyACE.reduce((sum, f) => sum + (f.properties.tickets_issued || 0), 0);
            
            // Find nearby bus routes
            const nearbyRoutes = transitData.bus_routes.features.filter(feature => {
                return feature.geometry.coordinates.some(coord => {
                    const distance = getDistance(lat, lng, coord[1], coord[0]);
                    return distance <= radius;
                });
            });
            
            const uniqueRoutes = [...new Set(nearbyRoutes.map(r => r.properties.route_name))].slice(0, 5);
            
            // Check if there's any relevant data in the area
            const hasData = totalCrashes > 0 || totalACETickets > 0 || uniqueRoutes.length > 0 || Object.keys(additionalInfo).length > 0;
            
            // Don't show popup if no data is found
            if (!hasData) {
                console.log('No data found in clicked area, skipping popup');
                return;
            }
            
            // Create popup content
            let popupContent = `
                <div style="max-width: 300px;">
                    <strong>${title || 'Area Analysis'}</strong><br>
                    <em>Within ${radius}m radius</em><br><br>
            `;
            
            if (Object.keys(additionalInfo).length > 0) {
                if (additionalInfo.stop_id) {
                    popupContent += `<strong>Stop ID:</strong> ${additionalInfo.stop_id}<br>`;
                }
                if (additionalInfo.routes_served) {
                    popupContent += `<strong>Routes:</strong> ${additionalInfo.routes_served}<br><br>`;
                }
            }
            
            popupContent += `
                <div style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin: 5px 0;">
                    <strong>Crashes:</strong> ${totalCrashes}<br>
                    <span style="color: #ff6b6b;">Injured:</span> ${totalInjured}<br>
                    <span style="color: #ff0000;">Killed:</span> ${totalKilled}
                </div>
                
                <div style="background: #4a2a4a; padding: 10px; border-radius: 5px; margin: 5px 0;">
                    <strong>ACE Enforcement:</strong><br>
                    <span style="color: #8A2BE2;">Tickets:</span> ${totalACETickets}
                </div>
                
                <div style="background: #2a4a2a; padding: 10px; border-radius: 5px; margin: 5px 0;">
                    <strong>Nearby Routes:</strong><br>
                    ${uniqueRoutes.length > 0 ? uniqueRoutes.join(', ') : 'None nearby'}
                </div>
                
                <div style="font-size: 10px; color: #888; margin-top: 10px;">
                    ${document.getElementById('month-display').textContent.includes('All') ? 'All time data' : `Data for: ${document.getElementById('month-display').textContent}`}
                </div>
                </div>
            `;
            
            new mapboxgl.Popup({ maxWidth: '350px' })
                .setLngLat(lngLat)
                .setHTML(popupContent)
                .addTo(map);
        }
        
        function getDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula to calculate distance in meters
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }


        function previousMonth() {
            if (!combinedData || !combinedData.crash_data.unique_months.length) return;
            
            if (isPlaying) {
                stopAnimation();
            }
            
            currentMonthIndex = currentMonthIndex > 0 ? currentMonthIndex - 1 : combinedData.crash_data.unique_months.length - 1;
            updateVisualization(false); // Don't smooth for manual navigation
        }
        
        function nextMonth() {
            if (!combinedData || !combinedData.crash_data.unique_months.length) return;
            
            if (isPlaying) {
                stopAnimation();
            }
            
            currentMonthIndex = (currentMonthIndex + 1) % combinedData.crash_data.unique_months.length;
            updateVisualization(false); // Don't smooth for manual navigation
        }
        
        function toggleAnimation() {
            if (isPlaying) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        function startAnimation() {
            isPlaying = true;
            document.getElementById('play-button').setAttribute('data-symbol', '⏸');
            
            // Calculate timing for consistent speed
            const monthCount = combinedData.crash_data.unique_months.length;
            const totalSliderRange = (monthCount - 1) * 1000;
            
            let currentSliderPosition = parseFloat(document.getElementById('time-slider').value) || 0;
            let lastFrameTime = performance.now();
            let lastDataUpdate = 0;
            
            // Calculate steps per second for consistent timing
            const baseStepsPerSecond = 500; // Base speed: 500 steps per second
            const stepsPerSecond = baseStepsPerSecond * playbackSpeed;
            
            const animateFrame = (currentTime) => {
                if (!isPlaying) return;
                
                // Calculate delta time for consistent speed regardless of frame rate
                const deltaTime = currentTime - lastFrameTime;
                lastFrameTime = currentTime;
                
                // Move based on actual time passed (60fps = ~16.67ms per frame)
                const stepsToMove = (stepsPerSecond * deltaTime) / 1000;
                currentSliderPosition += stepsToMove;
                
                // Handle looping
                if (currentSliderPosition >= totalSliderRange) {
                    if (isLoopEnabled) {
                        currentSliderPosition = 0;
                        lastDataUpdate = 0; // Reset data update timer
                    } else {
                        stopAnimation();
                        return;
                    }
                }
                
                // Update slider position only if user isn't interacting
                const slider = document.getElementById('time-slider');
                if (slider && !userInteracting) {
                    slider.value = currentSliderPosition;
                } else if (userInteracting) {
                    // If user is interacting, sync our internal position with slider
                    currentSliderPosition = parseFloat(slider.value) || currentSliderPosition;
                }
                
                // Update month index and visualization (less frequently for performance)
                const newMonthIndex = getMonthIndexFromSliderValue(currentSliderPosition);
                if (newMonthIndex !== currentMonthIndex) {
                    // Minimum time between data updates based on speed
                    const minUpdateInterval = Math.max(50, 200 / playbackSpeed);
                    if (currentTime - lastDataUpdate > minUpdateInterval) {
                        currentMonthIndex = newMonthIndex;
                        updateVisualization(false);
                        lastDataUpdate = currentTime;
                    }
                }
                
                // Continue animation
                animationId = requestAnimationFrame(animateFrame);
            };
            
            animationId = requestAnimationFrame(animateFrame);
        }

        function stopAnimation() {
            isPlaying = false;
            document.getElementById('play-button').setAttribute('data-symbol', '▶');
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }
        
        function toggleLoop() {
            isLoopEnabled = !isLoopEnabled;
            const loopButton = document.getElementById('loop-button');
            
            if (isLoopEnabled) {
                loopButton.style.backgroundImage = "url('Image_Sources/loop_enabled.png')";
                loopButton.style.backgroundColor = 'transparent';
                loopButton.style.backgroundSize = '22px 22px';
                loopButton.style.backgroundRepeat = 'no-repeat';
                loopButton.style.backgroundPosition = 'center';
                loopButton.style.filter = '';
                loopButton.title = 'Loop Enabled - Click to disable';
                loopButton.classList.add('active');
            } else {
                loopButton.style.backgroundImage = "url('Image_Sources/loop.png')";
                loopButton.style.backgroundColor = 'transparent';
                loopButton.style.backgroundSize = '22px 22px';
                loopButton.style.backgroundRepeat = 'no-repeat';
                loopButton.style.backgroundPosition = 'center';
                loopButton.style.filter = 'brightness(0) invert(1) opacity(0.6)';
                loopButton.title = 'Loop Disabled - Click to enable';
                loopButton.classList.remove('active');
            }
            
            console.log(`Loop ${isLoopEnabled ? 'enabled' : 'disabled'}`);
        }
        
        function toggleSpeed() {
            // Cycle through speeds: 1x -> 2x -> 4x -> 1x
            if (playbackSpeed === 1) {
                playbackSpeed = 2;
            } else if (playbackSpeed === 2) {
                playbackSpeed = 4;
            } else {
                playbackSpeed = 1;
            }
            
            // Update button display
            const speedButton = document.getElementById('speed-button');
            speedButton.textContent = `${playbackSpeed}x`;
            speedButton.title = `Playback Speed: ${playbackSpeed}x`;
            
            console.log(`Playback speed set to ${playbackSpeed}x`);
            
            // If currently playing, restart animation with new speed
            if (isPlaying) {
                stopAnimation();
                startAnimation();
            }
        }

        
        // Analysis panel toggle functionality (like loop button)
        function toggleAnalysisPanel() {
            analysisPanelVisible = !analysisPanelVisible;
            const toggleButton = document.getElementById('analysis-toggle');
            const sidebar = document.getElementById('story-sidebar');
            
            if (analysisPanelVisible) {
                // Panel is visible - show it and update button to show "hide" functionality
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                toggleButton.style.backgroundImage = "url('Image_Sources/analysis_enabled.png')";
                toggleButton.style.backgroundColor = 'transparent';
                toggleButton.style.backgroundSize = '16px 16px';
                toggleButton.style.backgroundRepeat = 'no-repeat';
                toggleButton.style.backgroundPosition = 'center';
                toggleButton.style.filter = '';
                toggleButton.title = 'Hide Analysis Panel';
                console.log('Analysis panel shown');
            } else {
                // Panel is hidden - hide it and update button to show "show" functionality  
                sidebar.style.visibility = 'hidden';
                sidebar.style.opacity = '0';
                toggleButton.style.backgroundImage = "url('Image_Sources/Analysis.png')";
                toggleButton.style.backgroundColor = 'transparent';
                toggleButton.style.backgroundSize = '16px 16px';
                toggleButton.style.backgroundRepeat = 'no-repeat';
                toggleButton.style.backgroundPosition = 'center';
                toggleButton.style.filter = 'brightness(0) invert(1) opacity(0.6)';
                toggleButton.title = 'Show Analysis Panel';
                console.log('Analysis panel hidden');
            }
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            // Add click event listener to analysis toggle
            const analysisToggle = document.getElementById('analysis-toggle');
            if (analysisToggle) {
                analysisToggle.addEventListener('click', toggleAnalysisPanel);
            }
        });
    </script>
</body>
</html>
